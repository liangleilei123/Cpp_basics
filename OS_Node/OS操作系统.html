<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}



mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
  stroke-width: 3;
}

g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

.MathJax g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}
mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
							stroke-width: 0;
						}
</style><title>OS操作系统</title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><h2 id='前言'><span>前言</span></h2><h3 id='什么是操作系统'><span>什么是操作系统</span></h3><ul><li><p><span>是计算机硬件和应用之间的一层软件</span></p><ul><li><span>方便我们使用硬件，如使用显存</span></li><li><span>高效的使用硬件，如开多个终端</span></li></ul></li></ul><p>&nbsp;</p><h3 id='windows系统的启动过程'><span>windows系统的启动过程</span></h3><p><span>两件事：把os读入内存；初始化系统的各个模块</span></p><p><span>1.系统启动之后，pc指针首先指向BIOS区，检测RAM，键盘，显示器，软硬磁盘是否正常运作，之后会把磁盘0磁道0扇区的256字节的引导启动代码放到内存0x7c00处，PC指该内存地址处开始运行。</span>
<span>该引导代码用汇编而不是用C语言，因为C语言的代码编译之后，它的内存位置是人为不可控的（比如自动分配栈），而汇编可以。</span>
<span>引导启动代码的第一步是：</span>
<span>（1）把256字节的代码从0x7c00处移动到0x9000处。然后从0x9000处开始运行。</span>
<span>（2）运行一开始读磁盘0磁道0扇区后面的4个setup扇区，把这4个扇区读到0x90200地址处。</span>
<span>（3）接下来的代码不读磁盘了，而是用13号中断在屏幕上显示加载系统的图片和文字。</span>
<span>（4）最后再把磁盘前5个扇区之后的内容读到内存</span>
<span>（5）程序跳到setup程序的地址去执行</span>
<span>（6）setup程序首先通过15号中断获得内存的大小等硬件参数。然后把从0x9000处所有的操作系统代码移到0地址处。（在物理内存中，操作系统就存放在低地址中）</span>
<span>（7）set up的最后代码是一条高级指令，它会把cr寄存器的最后一位置1，这样寻址方式从以前的模式转变为保护模式，寻址不再是cs左移4位加上ip地址，而是cs寄存器指向gdt表，找到基地址，然后加上ip寄存器的偏移地址来寻址，这样可以查找更大的空间，以前是寻址空间2的16次方，现在是2的32次方。</span>
<span>（8）接下来跳到system模块去执行，也就是前5个扇区之后的代码处去执行。</span>
<span>注意，磁盘上的程序一次是boot--setup--system程序，最终转变到内存中也要是这样的顺序，boot将setup的程序拿到内存，setup将system的程序拿到内存。system程序的开始一定是是head.s文件</span>
<span>（9）head.s文件会初始化idt和gdt表，这两个表格是寻址用的，以方便保护模式下使用，该模式下很多汇编指令改变，比如mov des  sor 变成</span>
<span>mov sor des,32位汇编代码和16位汇编代码不同。整个启动过程用了16位汇编，32位汇编，内嵌汇编三种。</span>
<span>(10)最后跳到main（）函数去执行，在main函数里面进行各个模块（键盘、鼠标、终端等等）的初始化工作。前面第6部获得的物理内存大小参数就可以传到一些初始化函数中进行使用。</span></p><p>&nbsp;</p><h2 id='操作系统接口'><span>操作系统接口</span></h2><ul><li><span>接口：连接两个东西、信号转换、屏蔽细节...</span></li><li><span>命令：一个用C语言写的程序</span></li><li><span>图像按钮：一个包括画图的C程序消息队列</span></li><li><span>操作系统接口：系统调用的函数。使用操作系统接口就是普通的c语言加上关键的函数。接口表现为函数调用，又由系统提供，所以称为系统调用。</span></li><li><span>操作系统接口可以查POSIX</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h2 id='系统调用的实现'><span>系统调用的实现</span></h2><p>&nbsp;</p><h3 id='用户段和核心段'><span>用户段和核心段</span></h3><ul><li><span>应用程序不能直接访问内核内核中的数据</span></li><li><span>系统调用实际上提供了应用程序进入内核的手段。</span></li><li><span>硬件把内存割成了两个区域：用户态和核心态，对应用户段和内核段。  </span></li></ul><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L5_1.png" referrerpolicy="no-referrer" alt="image-20220630204939385"></p><p>&nbsp;</p><p><a href='https://blog.csdn.net/better0332/article/details/3416749'><span>DPL,RPL,CPL 之间的联系和区别</span><em><span>better0332的博客-CSDN博客</span></em><span>dpl是什么</span></a></p><ul><li><span>CPL是当前进程的权限级别(Current Privilege Level)，是当前正在执行的代码所在的段的特权级，存在于cs寄存器的低两位。</span></li><li><span>RPL说明的是进程对段访问的请求权限(Request Privilege Level)</span></li><li><span>DPL存储在段描述符中，规定访问该段的权限级别(Descriptor Privilege Level)，表示目标内存段（用户段想访问的内核段）的特权级</span></li><li><span>DPL&gt;=CPL,即用户段的特权级高于核心段，用户段才能访问核心段，因为</span><strong><span>特权级越高，数字越小。</span></strong></li></ul><p>&nbsp;</p><h3 id='硬件提供了主动进入内核的方法'><span>硬件提供了“主动进入内核的方法”</span></h3><p>&nbsp;</p><ul><li><p><span>对于Intel x86，中断指令int(interrupt)用来进入内核</span></p><ul><li><span>int指令将使CS中的CPL改为0，“进入内核”</span></li><li><span>这是用户程序发起的调用内核代码的唯一方式</span></li></ul></li><li><p><span>系统调用的核心：</span></p><ul><li><span>用户程序包含一段含有int指令的代码</span></li><li><span>操作系统写中断处理，获取想调程序的编号</span></li><li><span>操作系统根据编号执行相应代码</span></li></ul></li></ul><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L5_2.png" referrerpolicy="no-referrer" alt="image-20220704111628887"></p><p>&nbsp;</p><h3 id='linux系统调用的实现细节'><span>Linux系统调用的实现细节</span></h3><ul><li><span>这是一段C语言内嵌汇编代码，将一个系统调用号置给eax，然后调用int 0x80</span></li></ul><p>&nbsp;</p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L5_3.png" referrerpolicy="no-referrer" alt="image-20220704111818194"></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h3 id='int-0x80中断的处理'><span>int 0x80中断的处理</span></h3><ul><li><span>初始化一个描述int 0x80 的中断门描述符，并添加到idt表，门描述符中的段选择符是0x0008，可以定位到GDT表的第二个表项，即核心代码段。</span></li></ul><p>&nbsp;</p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L5_4.png" referrerpolicy="no-referrer" alt="image-20220704112747330"></p><p>&nbsp;</p><h3 id='中断处理程序systemcall'><span>中断处理程序：system_call</span></h3><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L5_5.png" referrerpolicy="no-referrer" alt="image-20220704113730002"></p><p><span>一个内存地址对应8位就是一个内存地址存1个字节，所以*4就是找4个字节正好是下一个。中断号为4，那从中断向量表里找中断服务函数入口的时候就是</span><code>4*4</code><span>，即从表的初始地址往下加16个地址，就正好是16个字节，每四个字节一个入口</span></p><h3 id='syscalltable'><span>_sys_call_table</span></h3><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L5_6.png" referrerpolicy="no-referrer" alt="image-20220704113827057"></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='操作系统历史'><span>操作系统历史</span></h2><p>&nbsp;</p><p><span>1965-1980年，计算机开始进入多个行业，科学计算（IBM 7094）和银行（IBM 1401）</span></p><p><strong><span>OS/360</span></strong></p><ul><li><span>需要让一台计算机干多种事</span></li><li><span>多道程序</span></li><li><span>作业之间的切换和调度成为核心：因为既有IO任务，又有计算任务，需要让CPU忙碌（多进程结构和进程管理概念萌芽）</span></li></ul><p>&nbsp;</p><p><strong><span>从OS/360到MULTICS</span></strong></p><p><span>计算机进入多个行业，使用人数增加</span></p><ul><li><span>如果每个人启动一个作业，作业之间快速切换</span></li><li><span>分时系统</span></li><li><span>核心仍然是</span><strong><span>任务切换</span></strong><span>，但是资源复用的思想对操作系统影响芬达，</span><strong><span>虚拟内存就是一种复用</span></strong><span>。</span></li></ul><p>&nbsp;</p><p><strong><span>从MULTICS到UNIX（1980-1990）</span></strong></p><p><span>小型化计算机的出现，PDP-1每台售价120000美元</span></p><ul><li><span>越来越多的个人可以使用计算机</span></li><li><span>1969年：贝尔实验室在一台没人使用的PDP-7上开发一个简化MULTICS，就是后来的UNIX</span></li><li><span>UNIX是一个简化的MULTICS，核心概念差不多，但更灵活和成功。</span></li></ul><p>&nbsp;</p><p><strong><span>从UNIX到Linux(1990-2000)</span></strong></p><p><span>1981，IBM推出IBM PC；个人计算机开始普及</span></p><ul><li><span>很多人可以用计算机并接触UNIX</span></li><li><span>1987年Andrew Tanenbaum发布了MINIX（非常类似UNIX）用于教学</span></li><li><span>Linus Torvalds在386sx兼容微机上学习minix,作出小Linux于1991年发布</span></li><li><span>1994年，Linux1.0发布并采用GPL协议，1998年以后互联网世界里展开了一场历史性的linux产业化运动</span></li></ul><p>&nbsp;</p><h4 id='总结-1'><span>总结</span></h4><ul><li><span>用户通过执行程序来使用计算机</span></li><li><span>作为管理者，操作系统要让多个程序合理推进，就是进程管理</span></li><li><span>多进程（用户）推进时需要内存复用等等</span></li><li><span>多进程结构是操作系统基本图谱</span></li><li><span>学习方法：掌握操作系统的多进程图谱并实现它：CPU和内存管理</span></li><li><span>掌握操作系统的文件视图并实现：IO、磁盘和文件管理</span></li></ul><p><span>       </span></p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L7_1.png" referrerpolicy="no-referrer" alt="image-20220704204504105"></p><p>&nbsp;</p><h2 id='cpu管理的直观想法'><span>CPU管理的直观想法</span></h2><p>&nbsp;</p><p><span>CPU的工作原理：自动的取指执行。</span></p><p><span>管理CPU的最直观的方法是设置好程序计数器PC（program counter）的初值。当只有一个CPU时，程序在执行IO的时间远远大于只使用内存执行的时间大概是</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="6.267ex" height="2.005ex" role="img" focusable="false" viewBox="0 -864 2770.1 886" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.05ex;"><defs><path id="MJX-10-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-10-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-10-TEX-N-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path id="MJX-10-TEX-N-3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-10-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-10-TEX-N-30" transform="translate(500,0)"></use></g><g data-mml-node="mn" transform="translate(1033,393.1) scale(0.707)"><use data-c="36" xlink:href="#MJX-10-TEX-N-36"></use></g></g><g data-mml-node="mo" transform="translate(1714.3,0)"><use data-c="3A" xlink:href="#MJX-10-TEX-N-3A"></use></g><g data-mml-node="mn" transform="translate(2270.1,0)"><use data-c="31" xlink:href="#MJX-10-TEX-N-31"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>10</mn><mn>6</mn></msup><mo>:</mo><mn>1</mn></math></mjx-assistive-mml></mjx-container><script type="math/tex">10^6:1</script><span>。而程序调用IO的时候CPU是空闲的，这个时候可以去执行别的程序。由此，多个程序，交替执行（并发）就成为了管理CPU的核心。</span></p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L8_1.png" referrerpolicy="no-referrer" alt="image-20220709152502767"></p><p><span>但是在两个运行的程序进行切换的过程中给，只改变pc是不够的。一个程序应该在切换之前就保存好当前的信息。每个程序有一个存放信息的结构：PCB。</span></p><p>&nbsp;</p><h3 id='进程的引入'><span>进程的引入</span></h3><p><span>运行的程序和静态的程序是不一样的。</span></p><p><span>进程是进行（执行）中的程序。</span></p><ul><li><span>进程有开始、有结束，进程没有。</span></li><li><span>进程会走走停停，走停对程序无意义。</span></li><li><span>进程需要记录运行中的信息，程序不用。</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><h2 id='多进程图像'><span>多进程图像</span></h2><p>&nbsp;</p><h3 id='多个进程使用cpu的图像'><span>多个进程使用CPU的图像</span></h3><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L9_1.png" referrerpolicy="no-referrer" alt="image-20220709160603764"></p><ul><li><p><span>使用CPU：让程序执行起来</span></p></li><li><p><span>充分利用CPU：启动多个程序，交替执行</span></p></li><li><p><span>启动了的程序就是进程，所以是多个进程推进，</span></p><ul><li><span>操作系统只需要把这些进程记录好，要按照合理的次序推进（分配资源、进行调度）。每个进程创建一个进程管理块PCB，记录操作系统所需的，用于描述进程的当前情况以及控制进程运行的全部信息。</span></li><li><span>这就是多进程图像</span></li></ul></li></ul><p>&nbsp;</p><h3 id='多进程图像从启动开始到关机结束'><span>多进程图像从启动开始到关机结束</span></h3><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L9_2.png" referrerpolicy="no-referrer" alt="image-20220711103750722"></p><ul><li><p><span>main中的fork()创建了第一个进程 </span><code>if(!fork()) {init();}</code></p><ul><li><span>init执行了shell(windows桌面)</span></li></ul></li><li><p><span>shell再启动其他进程</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">//一命令启动一个进程，返回shell再启动其他进程...</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">int main(int argc,char *argc[])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>while(1){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>scanf("%s",cmd);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>if(!fork()){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>exec(cmd);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>wait();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 249px;"></div><div class="CodeMirror-gutters" style="display: none; height: 249px;"></div></div></div></pre></li></ul><p><span>fork()系统调用的作用是创建一个进程。原先存在的进程被称为“父进程”，新出现的被称为子进程。fork调用的一个奇妙之处就是它仅仅被调用一次，却能够返回两次，它可能有三种不同的返回值：</span></p><ol start='' ><li><span>在父进程中，fork返回新创建子进程的进程ID； </span></li><li><span>在子进程中，fork返回0； </span></li><li><span>如果出现错误，fork返回一个负值；</span></li></ol><p><span>fork出错可能有两种原因：（1）当前的进程数已经达到了系统规定的上限，这时errno的值被设置为EAGAIN。（2）系统内存不足，这时errno的值被设置为ENOMEM</span></p><p>&nbsp;</p><h3 id='多进程如何组织pcb状态队列'><span>多进程如何组织：PCB+状态+队列</span></h3><p><span>操作系统感知和管理进程全靠PCB。</span></p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L9_3.png" referrerpolicy="no-referrer" alt="image-20220711105635198"></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='多进程如何交替'><span>多进程如何交替</span></h3><p><span>启动磁盘读写：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pCur放到DiskWaitQueue</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">schedule</span>();<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//切换函数</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">schedule(){</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>pNew = getNext(ReadyQueue);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//在就绪队列中找到下一个进程，涉及到进程调度</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>switch_to(pCur,pNew);<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//pCur和pNew的信息都是从pcb中得到的</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="display: none; height: 91px;"></div></div></div></pre><p>&nbsp;</p><p><span>交替的三个部分：队列操作+调度+切换</span></p><p><span>getNext的一些算法：</span></p><ul><li><p><span>FIFO</span></p><ul><li><span>FIFO显然是一种公平的策略</span></li><li><span>FIFO显然没有考虑到进程执行的任务的区别</span></li></ul></li><li><p><span>Priority</span></p><ul><li><span>优先级该怎么设定？可能会使某些进程饥饿</span></li></ul></li></ul><p>&nbsp;</p><p><span>switch_to 函数代码：</span></p><p><span>要用汇编代码实现精细的控制</span></p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L9_4.png" referrerpolicy="no-referrer" alt="image-20220711111653523"></p><p>&nbsp;</p><h3 id='多个进程交替执行时会相互影响'><span>多个进程交替执行时会相互影响</span></h3><p><span>多个进程要交替执行，就必须都放在内存中，才能取指执行。</span></p><p><span>多进程同时存在于内存中会出现下面的问题：</span></p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L9_5.png" referrerpolicy="no-referrer" alt="image-20220711150738834"></p><p><span>进程1的代码在执行时访问进程2的内存地址，程序运行可能出错。</span></p><p><span>解决的办法：限制对地址100的读写。</span></p><p><span>多进程的地址空间分离：内存管理的主要内容。</span></p><p>&nbsp;</p><h3 id='限制进程间访问'><span>限制进程间访问:</span></h3><ul><li><span>每个进程会创建一个映射表，进程1的映射表将访问限制在进程1的范围内</span></li><li><span>进程1根本访问不到其他进程的内容</span></li><li><span>内存管理</span></li></ul><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L9_6.png" referrerpolicy="no-referrer" alt="image-20220711153548817"></p><p>&nbsp;</p><h3 id='多进程间合作生产者-消费者实例'><span>多进程间合作：生产者-消费者实例</span></h3><p><span>核心在于进程同步（合理的推进顺序）</span></p><ul><li><span>写counter时阻断其他进程访问counter</span></li></ul><p>&nbsp;</p><h3 id='如何形成多进程图像'><span>如何形成多进程图像</span></h3><ul><li><span>读写PCB,OS中最重要的结构，贯穿始终</span></li><li><span>要操作寄存器完成切换</span></li><li><span>要写调度程序</span></li><li><span>要有进程同步与合作</span></li><li><span>要有地址映射</span></li></ul><p>&nbsp;</p><h2 id='用户级线程'><span>用户级线程</span></h2><ul><li><p><span>进程=资源+指令序列</span></p><ul><li><span>将资源和指令执行分开</span></li><li><span>一个资源+多个指令执行序列</span></li></ul></li><li><p><span>进程之间的切换是执行序列和映射表一起切换</span></p></li><li><p><span>线程之间的切换是只切换执行序列。</span></p></li></ul><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220712211335446.png" alt="image-20220712211335446" style="zoom: 67%;" /></p><ul><li><span>线程保留了并发的优点，避免了进程切换的代价。</span></li><li><span>实质就是映射表不变而PC（程序计数器）指针变</span></li></ul><p>&nbsp;</p><h3 id='多个执行序列一个地址空间很实用'><span>多个执行序列+一个地址空间很实用</span></h3><ul><li><p><span>一个网页浏览器：</span></p><ul><li><span>一个线程用来从服务器接收数据</span></li><li><span>一个线程用来显示文本</span></li><li><span>一个线程用来处理图片（如解压缩）</span></li><li><span>一个线程用来显示图片</span></li></ul></li><li><p><span>这些线程共享资源</span></p><ul><li><span>接受数据放在100处，显示时要读</span></li><li><span>所有的文本，图片都显示在一个屏幕上</span></li></ul></li></ul><p>&nbsp;</p><h3 id='开始实现一个浏览器'><span>开始实现一个浏览器</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">WebExplorer</span>()</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">char</span> <span class="cm-variable">URL</span>[] <span class="cm-operator">=</span> <span class="cm-string">"http://cms.hit.edu.cn"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">char</span> <span class="cm-variable">buffer</span>[<span class="cm-number">1000</span>];<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//申请一段缓冲区，</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">pthread_create</span>(...,<span class="cm-variable">GetData</span>,<span class="cm-variable">URL</span>,<span class="cm-variable">buffer</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//创建线程，执行GetData函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">pthread_create</span>(...,<span class="cm-variable">Show</span>,<span class="cm-variable">buffer</span>);<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//创建线程，执行show函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">GetData</span>(<span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">URL</span>,<span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">p</span>){...};<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//从服务器下载数据包</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">Show</span>(<span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">p</span>){...};<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//从缓冲区读取数据并显示到显示器</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="display: none; height: 204px;"></div></div></div></pre><p><span>总体的框架是启动多个线程，每个线程交替执行。</span></p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L10_2.png" alt="image-20220714205617969" style="zoom:50%;" /></p><p>&nbsp;</p><h3 id='createyield'><span>create/yield</span></h3><ul><li><p><span>核心是Yield（进程切换函数）</span></p><ul><li><span>能切换了就知道切换时需要是个什么样子</span></li></ul></li><li><p><span>Create就是要制造出第一次切换时应该的样子</span></p></li></ul><p>&nbsp;</p><h3 id='两个执行程序共用一个栈'><span>两个执行程序共用一个栈</span></h3><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L10_3.png" alt="image-20220714212456322" style="zoom: 50%;" /></p><ul><li><span>在调用函数时会把函数结束的第一条指令压栈，这就是104-&gt;204-&gt;304-&gt;404</span></li><li><span>函数结束的‘}’会从栈中弹出地址继续往下执行。</span></li><li><span>两个执行程序共用一个栈，如上面那样，会出错。第三步结束本该跳转到104执行，结果从栈中弹出的404</span></li></ul><p>&nbsp;</p><h3 id='进程使用各自的栈'><span>进程使用各自的栈</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220715091317331.png" alt="image-20220715091317331" style="zoom:50%;" /></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//红色的Yield,第二步执行完切换到204的位置继续执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">Yield</span>(){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">TCB2</span>.<span class="cm-variable">esp</span> <span class="cm-operator">=</span> <span class="cm-variable">esp</span>;<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//用TCB2保存线程2的信息，TCB2保存线程2当前esp寄存器的地址，即线程2下一步要执行的地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">esp</span> <span class="cm-operator">=</span> <span class="cm-variable">TCB1</span>.<span class="cm-variable">esp</span>;<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//切换到线程1的地址栈</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//jmp 204;<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//应该去掉</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//执行这个右括号是就弹出204执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//执行到上面红色'}'，会弹出104开始执行</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="display: none; height: 204px;"></div></div></div></pre><p>&nbsp;</p><p><span>TCB简介</span></p><p><span>操作系统中一个线程对应着一个TCB（Thread Control Block），叫做线程控制模块，控制着线程的运行和调度。</span></p><p><span>相当于每个任务的信息都保存在这个结构中，这样在任务切换时，这个任务的信息就可以保存在任务上下文中。</span></p><p><span>TCB组成</span></p><ol start='' ><li><span>threadID：线程的唯一标识。</span></li><li><span>status：线程的运行状态</span></li><li><span>register：线程关于CPU中寄存器的情况</span></li><li><span>PC程序计数器：线程执行的下一条指令的地址</span></li><li><span>优先级：线程在操作系统调度的时候的优先级</span></li><li><span>线程的专属存储区：用于线程切换时存放现场保护信息，和与该线程相关的统计信息等;</span></li><li><span>堆栈指针（SP），在线程运行时，经常会进行过程调用，而过程的调用通常会出现多重嵌套的情况，这样，就必须将每次过程调用中所使用的局部变量以及返回地址保存起来。为此，应为每个线程设置一个堆栈，用它来保存局部变量和返回地址。相应地，在TCB中，也须设置两个指向堆栈的指针:指向用户自已堆栈的指针和指向核心栈的指针。前者是指当线程运行在用户态时，使用用户自己的用户栈来保存局部变量和返回地址，后者是指当线程运行在核心态时使用系统的核心栈。</span></li><li><span>用户栈：线程执行的用户方法栈，用来保存线程当前执行的用户方法的信息</span></li><li><span>内核栈：线程执行的内核方法栈，用来保存线程当前执行的内核方法信息。</span></li></ol><p>&nbsp;</p><h3 id='两个线程的样子两个tcb两个栈切换的pc在栈中'><span>两个线程的样子：两个TCB，两个栈，切换的PC在栈中</span></h3><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L10_5.png" alt="image-20220715095941744" style="zoom: 50%;" /></p><p><span>ThreadCreate的核心就是用程序做出这三样东西:</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220715100538899.png" alt="image-20220715100538899" style="zoom: 50%;" /></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">ThreadCreate</span>(<span class="cm-variable">A</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">TCB</span> <span class="cm-operator">*</span><span class="cm-variable">tcb</span> <span class="cm-operator">=</span> <span class="cm-variable">malloc</span>();<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//申请一段内存作为TCB</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">*</span><span class="cm-variable">stack</span> <span class="cm-operator">=</span> <span class="cm-variable">malloc</span>();<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//申请一段内存作为栈区</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">*</span><span class="cm-variable">stack</span> <span class="cm-operator">=</span> <span class="cm-variable">A</span>;<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-comment">//100<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//在栈中压入程序的初始地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tcb</span>.<span class="cm-variable">esp</span> <span class="cm-operator">=</span> <span class="cm-variable">stack</span>;<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//栈和TCB关联</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 159px;"></div><div class="CodeMirror-gutters" style="display: none; height: 159px;"></div></div></div></pre><p>&nbsp;</p><h3 id='将所有东西组合在一起'><span>将所有东西组合在一起</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220715101506252.png" alt="image-20220715101506252" style="zoom:50%;" /></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220715101158205.png" alt="image-20220715101158205" style="zoom:50%;" /></p><p><span>ThreadCreate首先创建了多个进程的用户栈和TCB，把起始地址都放在栈中，然后把TCB和栈进行关联。</span></p><p><span>在程序执行的过程中调用Yield，首先保存当前esp，然后切换栈，再弹栈切换线程继续执行。</span></p><p>&nbsp;</p><h3 id='用户级线程的优缺点'><span>用户级线程的优缺点？</span></h3><p>&nbsp;</p><p>&nbsp;</p><h2 id='内核级线程'><span>内核级线程</span></h2><p><span>内核，就是计算机学科意义上的操作系统，直接与硬件交互，提供CPU时间片管理、中断、内存管理、IO管理等等；总之一句话，内核就是操作系统中的一个子程序（提供最基础的功能），提供对软件层面的抽象（例如对进程、文件系统、同步、内存、网络协议等对象的操作和权限控制）和对硬件访问的抽象（例如磁盘的IO，显示，网卡（网络通信）等）。在内核调用IO时，由于调用IO时间较长，这段时间CPU空间，可以切换到其他进程执行。</span></p><ul><li><span>进程切换就是在内核级线程的基础上再额外切换一些资源，比如映射表。 因为每个进程占用的资源不一样，要切换进程必须要切换对应的资源，而</span><strong><span>切换资源必须要进入内核态进行处理。</span></strong></li><li><span>多核系统想要充分发挥其功能，必须支持核心级线程。</span></li><li><span>并发：对于单核CPU：同时出发，交替执行。</span></li><li><span>并行：对于多核CPU：同时出发，同时进行。</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><h3 id='内核级线程与用户级线程的不同'><span>内核级线程与用户级线程的不同</span></h3><ul><li><p><span>ThreadCreate是系统调用，内核管理TCB，内核负责切换线程</span></p></li><li><p><span>如何让切换成型？---内核栈，TCB</span></p><ul><li><span>用户栈还要用，执行的代码仍然在用户态，还要进行函数调用</span></li><li><span>内核级线程的栈区是一套一套的。一套中包含用户栈和内核栈。</span></li><li><span>实现两套栈（进行内核级线程的切换需要切换的两个线程的栈）是核心级线程的核心。</span></li><li><span>TCB关联内核栈，根据TCB切换一套栈，内核栈要切，用户栈也要切</span></li></ul></li></ul><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220715204306856.png" alt="image-20220715204306856" style="zoom:50%;" /></p><h3 id='用户栈和内核栈之间的关联'><span>用户栈和内核栈之间的关联</span></h3><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220715211735119.png" alt="image-20220715211735119" style="zoom:50%;" /></p><p><span>程序在执行时先是在用户栈跳转，一旦遇到中断（INT指令），计算机硬件的寄存器通过这个线程就找到了这个线程对应的内核栈，压入用户态执行的栈:  堆栈段寄存器SS（Stack Segment）和堆栈指针寄存器SP（Stack Pointer），SS存放栈顶段地址，SP存放栈顶偏移地址，跳转都是SP移动。还要压CS和PC。</span></p><ul><li><span>SS，SP是指用户态执行时，已执行部分的一些变量的值，后续执行需要知道之前变量的数值。</span></li><li><span>CS（代码段基址），PC是存放用户栈的代码段的，表示后续返回执行时需要知道从代码的那个位置开始执行。</span></li><li><span>用户态切换时人为控制的，而内核线程的切换是硬件本身自带的特性，需要改变物理线路来回切换线程。</span></li><li><span>内核栈的五个寄存器作为指针指向用户栈。</span></li></ul><p>&nbsp;</p><h3 id='用例子说明用户态和内核态的切换'><span>用例子说明用户态和内核态的切换</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220715213115597.png" alt="image-20220715213115597" style="zoom:50%;" /></p><p><span>程序从函数A开始执行，</span></p><ul><li><span>调用函数B时把104压入栈中，在函数B中调用read函数，把204压入栈中。然后函数read函数中遇到中断，把对应的五个寄存器压入栈中，SS存放栈顶段寄存器，SP指向段内偏移，即用户态接下来要跳转的地址。中断完要跳转的地址304存放在PC寄存器中。</span></li><li><span>然后开始执行1000,在内核中继续往下执行sys_read();</span></li></ul><p>&nbsp;</p><h3 id='开始内核中的切换switchto'><span>开始内核中的切换：switch_to</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220716094310036.png" alt="image-20220716094310036" style="zoom: 50%;" /></p><p><span>switch_to:用当前的S线程的TCB，把当前S的栈顶地址esp存下来，存下来之后，进入到next下一个线程T，这时要把T线程的TCB中的栈顶地址拿出来赋给esp寄存器，这样才能把T线程的栈利用起来。</span></p><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220716095451620.png" alt="image-20220716095451620" style="zoom:50%;" /></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220716103858052.png" alt="image-20220716103858052" style="zoom: 67%;" /></p><p><span>整个过程就是，在进程S用户态时遇到中断，进入内核态，在执行时遇到调用io的情况，内核级线程阻塞。内核级线程切换（switch_to），切换到进程T的内核级线程运行，在这段线程中遇到iret（中断返回），跳转到用户态执行。</span></p><p>&nbsp;</p><h3 id='内核线程switchto切换的五段论'><span>内核线程switch_to切换的五段论</span></h3><p><span>从下往上，从左往右。</span></p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L11_7.png" referrerpolicy="no-referrer" alt="image-20220716104757656"></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='threadcreate'><span>ThreadCreate</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220716110403717.png" alt="image-20220716110403717" style="zoom:50%;" /></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">TreadCreate</span>(...)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">TCB</span> <span class="cm-variable">tcb</span> <span class="cm-operator">=</span> <span class="cm-variable">get_free_page</span>();<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//先申请一段内存作为内核栈<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span></span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">*</span><span class="cm-variable">krlstack</span> <span class="cm-operator">=</span> ...;<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//初始化内核栈</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">*</span><span class="cm-variable">userstack传入</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">填写两个stack</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tcb</span>.<span class="cm-variable">esp</span><span class="cm-operator">=</span><span class="cm-variable">krlstack</span>;<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//tcb关联内核栈</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tcb</span>.<span class="cm-variable">状态</span><span class="cm-operator">=</span><span class="cm-variable">就绪</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tcb入队</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 227px;"></div><div class="CodeMirror-gutters" style="display: none; height: 227px;"></div></div></div></pre><p>&nbsp;</p><h3 id='用户级线程和内核级线程对比'><span>用户级线程和内核级线程对比</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220716111707923.png" alt="image-20220716111707923" style="zoom:50%;" /></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='内核级线程的代码实现不懂）'><span>内核级线程的代码实现（不懂）</span></h2><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220727093027795.png" alt="image-20220727093027795" style="zoom: 67%;" /></p><p><span>内核栈在中断引起的时候创建。</span></p><p><strong><span>中断入口：</span></strong><span>在执行INT指令时，CPU找到当前的内核栈，压入当前的SS和SP（在INT指针执行时还没进入内核，执行完成后才进入内核），当前的SS和SP指向的是用户栈，还把当前的CS和IP压进来。然后执行INT 0x80的中断处理函数system_call。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220727100721739.png" alt="image-20220727100721739" style="zoom: 67%;" /></p><p><span>system_call也要压栈，把用户态的一堆东西压栈，把刚才用户态的执行现场在内核态保存起来。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">_system_call</span>:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">push</span> %<span class="cm-keyword">ds</span>..%<span class="cm-keyword">fs</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">push</span> %<span class="cm-variable-2">edx</span>...<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">;把用户态的执行现场在内核态保存起来</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">call</span> <span class="cm-keyword">sys_fork</span><span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">;进入内核中具体处理sys_fork,在执行sys_fork时可能会引起切换</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">pushl</span> %<span class="cm-variable-2">eax</span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">movl</span> <span class="cm-builtin">_current</span>,%<span class="cm-variable-2">eax</span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">;把current（当前进程）赋给eax</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">cmpl</span> $0,state(%<span class="cm-variable-2">eax</span>)<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-comment">;看PCB中的state是不是等于0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">jne</span> <span class="cm-keyword">reschedule</span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">;jne表示不相等，即上条语句不等于0，reschedule引发完成内核栈的切换</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">cmpl</span> $0,counter(%<span class="cm-variable-2">eax</span>)<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-comment">;看当前进程的时间片</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">je</span> <span class="cm-keyword">reschedule</span><span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">;时间片用光了，也要进行切换</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tag">ret_from_sys_call:</span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">;在切换完成后会跳回这个函数，系统调用返回</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">reschedule:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">pushl</span> $ret_from_sys_call</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">jmp</span> <span class="cm-builtin">_schedule</span><span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">;执行C函数</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 340px;"></div><div class="CodeMirror-gutters" style="display: none; height: 340px;"></div></div></div></pre><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220727104045726.png" alt="image-20220727104045726" style="zoom:67%;" /></p><p><strong><span>中断出口：</span></strong><span>执行完reschedule之后，第五步就是执行ret_from_sys_call，此时已经是线程2，把该线程之前压入栈中的数据依次弹出。</span></p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L12_3.png" referrerpolicy="no-referrer" alt="image-20220727112542010"></p><p><span>TSS全称为task state segment,是指在操作系统进程管理的过程中，进程切换时的任务现场信息。</span></p><p><span>1.原来的TSS段是通过一个TR来查找的（类似于一个指针存贮着任务信息的地址）</span></p><p><span>2.当进行核心线程切换的时候，会将TR指向第二个线程描述符</span></p><p><span>3.第2步中，将TR切换到新的线程段，所以将此时的线程信息填入到CPU中</span></p><p><span>PCB和tss工作方式不一样。pcb用栈存信息，用的是精简指令如pop等。tss需要cpu拥有tr这个寄存器结构，tr指示当前task正在使用的相关信息表，用一条复杂指令在task切换时完成换表。</span></p><p>&nbsp;</p><p><a href='https://blog.csdn.net/wyyy2088511/article/details/119357473'><span>linux0.11中switch_to理解</span><em><span>jena_wy的博客-CSDN博客</span></em><span>linux switch_to</span></a></p><p><span>可以知道ljmp将跳转到选择子指定的地方，大致过程是，ljmp判断选择子为TSS类型，于是就告诉硬件要切换任务，硬件首先它要将当前的PC,esp,eax等现场信息保存在当前自己的TSS段描述符中,然后再将目标TSS段描述符中的pc,esp,eax的值拷贝至对应的寄存器中.当这些过程全部做完以后内核就实现了内核的切换</span></p><p>&nbsp;</p><p><span>接下来的目标就是做好TSS，要做好TSS，首先得有线程控制块TCB,还需要有内核栈，然后再把TSS做好，做好之后就能切换。</span></p><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220727142640209.png" alt="image-20220727142640209" style="zoom:67%;" /></p><p><code>_sys_fork</code><span>是五段论中的第一段，中断入口。进入</span><code>_sys_fork</code><span>之后要执行 </span><code>_copy_process</code><span>函数。内核栈的内容全部作为copy_process的参数，这样就能从父进程创建一个子进程。</span></p><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220727145111576.png" alt="image-20220727145111576" style="zoom:67%;" /></p><p>&nbsp;</p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L12_6.png" referrerpolicy="no-referrer" alt="image-20220727145254802"></p><p><span>eip是INT指令执行完的下一句话</span></p><p>&nbsp;</p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L12_7.png" referrerpolicy="no-referrer" alt="image-20220727151833150"></p><p>&nbsp;</p><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220727151900292.png" alt="image-20220727151900292" style="zoom: 67%;" /></p><p>&nbsp;</p><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220727151934289.png" alt="image-20220727151934289" style="zoom:67%;" /></p><p>&nbsp;</p><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220727152009378.png" alt="image-20220727152009378" style="zoom:67%;" /></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='cpu调度策略'><span>CPU调度策略</span></h2><p>&nbsp;</p><h3 id='设计调度算法的目标时间短'><span>设计调度算法的目标：时间短</span></h3><ul><li><span>尽快结束任务：周转时间（从任务进入到任务结束）短</span></li><li><span>用户操作尽快响应：响应时间（从操作发生到响应）短</span></li><li><span>系统内耗时间少：吞吐量（完成的任务量） 大</span></li></ul><p><span>总原则：系统专注于任务执行，又能合理调配任务</span></p><p>&nbsp;</p><p><span>如何做到合理？需要折中，需要综合...</span></p><ul><li><p><span>吞吐量和响应时间之间有矛盾</span></p><ul><li><span>响应时间小--&gt;切换次数多--&gt;系统内耗大--&gt;吞吐量小</span></li></ul></li><li><p><span>前台任务和后台任务的关注点不同</span></p><ul><li><span>前台任务关注响应时间，后台任务关注周转时间</span></li></ul></li><li><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L14_1.png" alt="image-20220808195302955" style="zoom:50%;" /></p></li></ul><p>&nbsp;</p><h3 id='各种调度算法'><span>各种调度算法</span></h3><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220808203454593.png" alt="image-20220808203454593" style="zoom:50%;" /></p><p><span>先来先服务（FCFS）：按到达时间排序，先到的先执行。平均周转时间会长</span></p><p><span>P1--&gt;P2--&gt;P3--&gt;P4--&gt;P5</span></p><p>&nbsp;</p><p><span>短作业优先（SJF）：假设所有任务同时到达,CPU执行时间短的优先。平均周转时间最短</span></p><p><span>P3--&gt;P4--&gt;P1--&gt;P5--&gt;P2</span></p><p>&nbsp;</p><p><span>按时间片来轮转调度（RR）：</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220808204510500.png" alt="image-20220808204510500" style="zoom:50%;" /></p><p>&nbsp;</p><h3 id='响应时间和周转时间同时存在怎么办'><span>响应时间和周转时间同时存在，怎么办</span></h3><ul><li><span>一个调度算法让多种类型的任务同时都满意，怎么办？</span></li><li><span>直观想法：定义前台任务和后台任务两队列，前台RR，后台SJF，只有前台任务没有时才调度后台任务</span></li></ul><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220808205139593.png" alt="image-20220808205139593" style="zoom:50%;" /></p><p><span>如果一直有前台任务，可能会有后天任务一直无法执行。</span></p><ul><li><span>解决办法：后台任务优先级动态升高，但后台任务（用SJF调度）一旦执行，前台的响应时间可能会变长</span></li><li><span>前后台任务都用时间片，但又退化为RR，后台任务的SJF该如何体现，前台任务如何照顾</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><p><span>还有其他问题：</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220808211008541.png" alt="image-20220808211008541" style="zoom:50%;" /></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='一个实际的schedule函数'><span>一个实际的schedule函数</span></h2><p><span>首先是找到所有就绪态任务的最大counter，大于零则切过去.否则更新所有任务的counter，即右移一位再加priority。然后进入下一次的找最大counter大于零则切否则更新counter，所以说那些没在就绪态的counter就一直在更新，数学证明出等的时间越长counter越大，等他们变成就绪态了，由于counter大，也就可以优先切过去了。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">Schedule</span>(<span class="cm-variable-3">void</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span>(<span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>; <span class="cm-variable">next</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-variable">NR_TASKS</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-operator">&amp;</span><span class="cm-variable">task</span>[<span class="cm-variable">NR_TASKS</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span>(<span class="cm-operator">--</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>((<span class="cm-operator">*</span><span class="cm-variable">p</span><span class="cm-operator">-&gt;</span><span class="cm-variable">state</span> <span class="cm-operator">==</span> <span class="cm-variable">TASK_RUNNING</span><span class="cm-operator">&amp;&amp;</span>(<span class="cm-operator">*</span><span class="cm-variable">p</span>)<span class="cm-operator">-&gt;</span> <span class="cm-variable">counter</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">c</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">c</span> <span class="cm-operator">=</span> (<span class="cm-operator">*</span><span class="cm-variable">p</span>) <span class="cm-operator">-&gt;</span><span class="cm-variable">counter</span>,<span class="cm-variable">next</span> <span class="cm-operator">=</span> <span class="cm-variable">i</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-comment">//找到队列中就绪态最大的counter</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">c</span>) <span class="cm-keyword">break</span>;<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//跳出循环执行该进程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//1.当不存在就绪态进程后，c=-1，执行for循环</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//2.for循环，使就绪态进程（counter=0）=priority，而阻塞态进程counter&gt;priority</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//3.当阻塞态 就绪后，将会立即获得高优先级</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span>(<span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-operator">&amp;</span><span class="cm-variable">LAST_TASK</span>;<span class="cm-variable">p</span><span class="cm-operator">&gt;&amp;</span><span class="cm-variable">FIRST_TASK</span>;<span class="cm-operator">--</span><span class="cm-variable">p</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>(<span class="cm-operator">*</span><span class="cm-variable">p</span>)<span class="cm-operator">-&gt;</span><span class="cm-variable">counter</span> <span class="cm-operator">=</span> ((<span class="cm-operator">*</span><span class="cm-variable">p</span>)<span class="cm-operator">-&gt;</span><span class="cm-variable">counter</span><span class="cm-operator">&gt;&gt;</span><span class="cm-number">1</span>)<span class="cm-operator">+</span>(<span class="cm-operator">*</span><span class="cm-variable">p</span>)<span class="cm-operator">-&gt;</span><span class="cm-variable">priority</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">switch_to</span>(<span class="cm-variable">next</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 453px;"></div><div class="CodeMirror-gutters" style="display: none; height: 453px;"></div></div></div></pre><p><span>counter表示优先级，优先级越高，数字越大。counter表示的是进程进入就绪态时间。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220810154230937.png" alt="image-20220810154230937" style="zoom:50%;" /></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220810154318238.png" alt="image-20220810154318238" style="zoom:50%;" /></p><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220810155133684.png" alt="image-20220810155133684" style="zoom:50%;" /></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='进程同步与信号量'><span>进程同步与信号量</span></h2><p><span>目的：让多进程之间的合作变得合理有序</span></p><p><span>单生产者单消费者用信号：</span></p><p><span>有一个缓冲区，缓冲区满的时候生产者睡眠，消费者工作，消费者工作完之后缓冲区有空闲，唤醒生产者。</span></p><p><span>当生产者不工作，缓冲区为空时，消费者睡眠。</span></p><p>&nbsp;</p><p><span>（多）生产者（多）消费者用信号量：</span></p><p><span>有一个缓冲区，缓冲区满的时候生产者睡眠，当有第二个生产者工作时，该生产者也睡眠，用信号量sem记录睡眠的生产者的数量，消费者工作，消费者工作完之后查看sem,如果有睡眠的生产者，唤醒该生产者。当生产者不工作，缓冲区为空时，消费者睡眠。生产者可以当作进程。</span></p><p>&nbsp;</p><p><span>进程同步：需要让“进程走走停停”来保证多进程合作的合理有序。用wakeup函数和sleep函数来通知进程的走走停停。</span></p><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//申请缓冲区</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define BUFFER_SIZE 10<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span></span><span class="cm-comment">//BUFFER_SIZE是缓冲区的大小。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">typedef</span> <span class="cm-keyword">struct</span>{...} <span class="cm-variable">item</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">item</span> <span class="cm-variable">buffer</span>[<span class="cm-variable">BUFFER_SIZE</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">in</span> <span class="cm-operator">=</span> <span class="cm-variable">out</span> <span class="cm-operator">=</span> <span class="cm-variable">counter</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//counter表示的是缓冲区中有效内容单元的个数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//生产者进程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span>(<span class="cm-atom">true</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span>(<span class="cm-variable">counter</span> <span class="cm-operator">==</span> <span class="cm-variable">BUFFER_SIZE</span>)<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//缓存区满，生产者要停</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sleep</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">buffer</span>[<span class="cm-variable">in</span>] <span class="cm-operator">=</span> <span class="cm-variable">item</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">in</span> <span class="cm-operator">=</span> (<span class="cm-variable">in</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>)<span class="cm-operator">%</span><span class="cm-variable">BUFFER_SIZE</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">counter</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">counter</span> <span class="cm-operator">==</span> <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wakeup</span>(<span class="cm-variable">消费者</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//消费者进程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span>(<span class="cm-atom">true</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span>(<span class="cm-variable">counter</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>)<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//缓存区空，消费者要停</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sleep</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">item</span> <span class="cm-operator">=</span> <span class="cm-variable">buffer</span>[<span class="cm-variable">out</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">out</span> <span class="cm-operator">=</span> (<span class="cm-variable">out</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>)<span class="cm-operator">%</span><span class="cm-variable">BUFFER_SIZE</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">counter</span><span class="cm-operator">--</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">counter</span> <span class="cm-operator">==</span> <span class="cm-variable">BUFFER_SIZE</span><span class="cm-operator">-</span><span class="cm-number">1</span>)<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//只发信号还不能解决全部问题</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wakeup</span>(<span class="cm-variable">生产者</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 793px;"></div><div class="CodeMirror-gutters" style="display: none; height: 793px;"></div></div></div></pre><p><span>只发信号不能解决全部问题：</span></p><p><span>如果出现了这样的进程调度情况:在缓存区满时进来两个生产者进程,然后又进来一个消费者进程,这时会怎么样?缓存区满时进来生产者进程 P,counter==BUFFER_SIZE条件成立,P会进入阻塞态等待信号empty。又进来一个生产者进程 P2, counter == BUFFER.SIZE条件仍然成立,P也会进入阻塞态等待信号 empty。现在又进来一个消费者进程C,C消费了一个内容单元 (item), counter--,判断条件 counter == BUFFER.SIZE-1,条件成立,C会发生信号 empty唤醒进程P,到目前为止,进程间的同步关系是正确的。现在C进程再循环执行一次又用掉了一个内容单元(item),执行 counter--,判断条件 counter == BUFFER.</span><em><span>SIZE-1,由于此时counter = BUFFER.</span></em><span>SIZE-2,判断条件不成立,所以P不能被唤醒,仍然处于阻塞态等待信号 empty。按照语义,现在有了一个空闲单元,却有一个生产者进程被阻塞需等待空闲单元的到来，显然不正确。</span></p><p>&nbsp;</p><h3 id='从信号到信号量'><span>从信号到信号量</span></h3><p><span>不能只是等待信号（睡眠）和发信号（唤醒）。还应该记录一些信息。</span></p><ul><li><span>能记录有“2个进程等待”就行了，引入一个变量sem记录信号量</span></li></ul><ol start='' ><li><span>缓冲区满，P1执行，P1sleep，记录下1个进程等待。   sem = -1; </span></li><li><span>P2执行，P2 sleep，记录下2个进程等待                         sem = -2;</span></li><li><span>C执行1次循环，发现2个进程等待，wakeup 1个           sem = -1;</span></li><li><span>C再执行1次循环，发现?个进程等待，再?                        sem = 0;</span></li><li><span>C再执行1次循环，怎么办?                                                 sem = 1;</span></li><li><span>再来一个p3,生产者就不需要睡眠，令sem = 0表示缓冲区已满</span></li></ol><p>&nbsp;</p><p><span>信号量的定义：</span></p><p><span> 1965年，迪杰斯特拉（Dijkstra）提出的一种特殊整形变量，量用来记录，信号用来sleep和weakup</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">semaphore</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">value</span>;<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//记录资源个数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">PCB</span> <span class="cm-operator">*</span><span class="cm-variable">queue</span>;<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//记录等待在该信号量上的进程，是一个阻塞队列</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">P</span>(<span class="cm-variable">semaphore</span> <span class="cm-variable">s</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//申请资源</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">v</span>(<span class="cm-variable">semaphore</span> <span class="cm-variable">s</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//消费资源</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-variable">p</span>(<span class="cm-variable">semaphore</span> <span class="cm-variable">s</span>)<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">s</span>.<span class="cm-variable">value</span><span class="cm-operator">--</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">s</span>.<span class="cm-variable">value</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>)<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//刚才是欠资源或没有资源</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">sleep</span>(<span class="cm-variable">s</span>.<span class="cm-variable">queue</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-comment">//当前进程睡眠 &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">v</span>(<span class="cm-variable">semaphore</span> <span class="cm-variable">s</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">s</span>.<span class="cm-variable">value</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">s</span>.<span class="cm-variable">value</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">0</span>)<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//表示还有进程在睡眠</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">wakeup</span>(<span class="cm-variable">s</span>.<span class="cm-variable">queue</span>);<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//唤醒睡眠的进程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//用信号量解生产者-消费者问题</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//用文件定义共享缓冲区</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">fd</span> <span class="cm-operator">=</span> <span class="cm-variable">open</span>(<span class="cm-string">"buffer.txt"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">write</span>(<span class="cm-variable">fd</span>,<span class="cm-number">0</span>,<span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">int</span>));<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//写in</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">write</span>(<span class="cm-variable">fd</span>,<span class="cm-number">0</span>,<span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">int</span>));<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//写out</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//信号量的定义和初始化</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">semaphore</span> <span class="cm-variable">full</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//full表示生产出内容单元的数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">semaphore</span> <span class="cm-variable">empty</span> <span class="cm-operator">=</span> <span class="cm-variable">BUFFER_SIZE</span>;<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//用empty表示缓冲区是否满</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">semaphore</span> <span class="cm-variable">mutex</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//共享缓冲区可否使用的标识</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//生产者</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Producer</span>(<span class="cm-variable">item</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">P</span>(<span class="cm-variable">empty</span>);<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//先判断有没有空闲的缓冲区，没有就睡眠</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">P</span>(<span class="cm-variable">mutex</span>);<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//有空闲，将mutex置为0，阻止其他进程进入共享缓冲区</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">读入in</span>;<span class="cm-variable">将item写入到in的位置上</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">v</span>(<span class="cm-variable">mutex</span>);<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//将mutex置为1，将共享缓冲区开放</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">V</span>(<span class="cm-variable">full</span>);<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//由于进行一次生产，缓冲区内容单元+1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//消费者</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Consumer</span>(){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">P</span>(<span class="cm-variable">full</span>);<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//先判断缓冲区有没有内容单元</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">P</span>(<span class="cm-variable">mutex</span>);<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//将mutex置为0，阻止其他进程进入共享缓冲区</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">读入out</span>;<span class="cm-variable">将文件中的out位置读出到item</span>;<span class="cm-variable">打印item</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">v</span>(<span class="cm-variable">mutex</span>);<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//将mutex置为1，将共享缓冲区开放</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">V</span>(<span class="cm-variable">empty</span>);<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">////由于进行一次消费，缓冲区空闲位置+1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1179px;"></div></div></div></pre><p>&nbsp;</p><h2 id='信号量临界区保护'><span>信号量临界区保护</span></h2><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//接上一节</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">empty</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//假如初始的empty的初始值等于-1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//有两个生产者，由于生产者的睡眠是在s.value之后，所以一个生产者的P操作没有结束，而另一个生产者的P操作工作时，就会出现empty出错的问题</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//生产者P1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-variable">empty</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-keyword">register</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">empty</span> <span class="cm-operator">=</span> <span class="cm-keyword">register</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//生产者P2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-variable">empty</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-keyword">register</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">empty</span> <span class="cm-operator">=</span> <span class="cm-keyword">register</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//一个可能执行的调度</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">P1</span>.<span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-variable">empty</span>;<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//P1.register = -1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-variable">P1</span>.<span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-variable">P1</span>.<span class="cm-keyword">register</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//P1.register = -2;<span class="cm-tab" role="presentation" cm-text="	"> </span></span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">P2</span>.<span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-variable">empty</span>;<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//P2.register = -1;正确情况下应该等于-2，在P1的P操作没有执行完，empty没有返回时，P2对empty进行操作</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">P2</span>.<span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-variable">P2</span>.<span class="cm-keyword">register</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//P2.register = -2;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">empty</span> <span class="cm-operator">=</span> <span class="cm-variable">P1</span>.<span class="cm-keyword">register</span>;<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//empty = -2;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">empty</span> <span class="cm-operator">=</span> <span class="cm-variable">p2</span>.<span class="cm-keyword">register</span>;<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//empty = -2;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//解决办法</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//在写共享变量empty时阻止其他进程访问empty，就是操作系统的PV原子操作，</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//生产者P1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">先检查并给empty上锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">P1</span>.<span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-variable">empty</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">P1</span>.<span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-variable">P1</span>.<span class="cm-keyword">register</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//生产者P2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">检查empty时发现有锁，不执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">empty</span> <span class="cm-operator">=</span> <span class="cm-variable">P1</span>.<span class="cm-keyword">register</span>;<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//P1继续执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">给empty开锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//生产者P2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">先检查并给empty上锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">P2</span>.<span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-variable">empty</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">P2</span>.<span class="cm-keyword">register</span> <span class="cm-operator">=</span> <span class="cm-variable">P2</span>.<span class="cm-keyword">register</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">empty</span> <span class="cm-operator">=</span> <span class="cm-variable">P2</span>.<span class="cm-keyword">register</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">给empty开锁</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 952px;"></div><div class="CodeMirror-gutters" style="display: none; height: 952px;"></div></div></div></pre><p>&nbsp;</p><h3 id='临界区'><span>临界区</span></h3><p><span>一次只允许一个进程进入的该进程的那一段代码。临界区一定成对或成组的出现。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220811155409534.png" alt="image-20220811155409534" style="zoom:50%;" /></p><p><span>读写信号量的代码一定是临界区。</span></p><p>&nbsp;</p><p><span>临界区代码保护的原则：</span></p><ul><li><p><span>基本原则:互斥进入:如果一个进程在临界区中执行，则其他进程不允许进入</span></p><ul><li><span>这些进程间的约束关系称为互斥(mutual exclusion)</span></li><li><span>这保证了是临界区</span></li></ul></li><li><p><span>好的临界区保护原则</span></p><ul><li><span>有空让进:若干进程要求进入空闲临界区时，应尽快使一进程进入临界区</span></li><li><span>有限等待:从进程发出进入请求到允许进入，不能无限等待</span></li></ul></li></ul><p>&nbsp;</p><p><span>问题来了，怎么控制进程进入临界区</span></p><h3 id='一个不好的方法轮转法'><span>一个不好的方法：轮转法</span></h3><p><span>用一个变量turn来让两个进程交替执行</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220811160420796.png" alt="image-20220811160420796" style="zoom:50%;" /></p><p><span>turn不能等于1的同时又等于0，但是当p0进入临界区后，p1不进去临界区，那p0就不能再进入临界区了。</span><strong><span>不满足有空让进</span></strong></p><p>&nbsp;</p><h3 id='改进的方法标记法'><span>改进的方法：标记法</span></h3><p><span>通过标记指明是否有进程进入临界区，且当前临界区是否有锁。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220811161446641.png" alt="image-20220811161446641" style="zoom:50%;" /></p><p><span>由图可知，当进程P1刚修改完临界区，P2就修改临界区，</span><strong><span>会造成两个进程无限等待</span></strong><span>。</span></p><p>&nbsp;</p><h3 id='peterson算法结合轮转法和标记法'><span>Peterson算法，结合轮转法和标记法</span></h3><p><span>两个进程进行切换</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220811162058497.png" alt="image-20220811162058497" style="zoom:50%;" /></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220811162358407.png" alt="image-20220811162358407" style="zoom:50%;" /></p><p>&nbsp;</p><h3 id='多进程切换-面包店算法纯软件算法复杂'><span>多进程切换-面包店算法(纯软件，算法复杂)</span></h3><ul><li><p><span>仍然是标记和轮转的结合</span></p><ul><li><span>如何轮转：每个进程都获得一个序号，</span></li><li><span>如何标记：进程离开时序号为0，不为0的序号即标记</span></li><li><span>面包店：每个进入商店的客户都获得一个号码（当前号中最大的+1），号码最小的先得到服务；号码相同时，名字靠前的先服务。</span></li></ul></li></ul><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220811162805486.png" alt="image-20220811162805486" style="zoom:50%;" /></p><p>&nbsp;</p><h3 id='多进程操作的第二种方法'><span>多进程操作的第二种方法</span></h3><p><span>开关中断</span></p><p><span>一个进程在临界区的时候，另一个进程只有经过调度才能进入相同临界区。所以一个进程在临界区时阻止调度就可以保护当前信号量。</span></p><p><span>进程切换时，时钟中断让时间片-1，当前进程的时间片用完了，进程切换。所以只要阻止时钟中断，进程也就不会切换。</span></p><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//单CPU</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cli</span>();<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//关中断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">临界区</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">sli</span>();<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//开中断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//多核时，每个cpu都有一个中断，会冲突</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 136px;"></div><div class="CodeMirror-gutters" style="display: none; height: 136px;"></div></div></div></pre><p>&nbsp;</p><p>&nbsp;</p><h3 id='多进程操作的第三种方法'><span>多进程操作的第三种方法</span></h3><p><span>临界区保护的硬件原子指令法</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">boolean</span> <span class="cm-def">TestAndSet</span>(<span class="cm-variable">boolean</span> <span class="cm-operator">&amp;</span><span class="cm-variable">x</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{<span class="cm-comment">//硬件原子指令，一次性执行完毕</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">boolean</span> <span class="cm-variable">rv</span> <span class="cm-operator">=</span> <span class="cm-variable">x</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">rv</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span>(<span class="cm-variable">TestAndSet</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">lock</span>));<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//lock的初值时false时，return false跳出循环，lock设为true阻止其他进程进入临界区</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">临界区</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lock</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//临界区执行完毕，lock改为false,允许其他进程进入临界区</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">剩余区</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 272px;"></div><div class="CodeMirror-gutters" style="display: none; height: 272px;"></div></div></div></pre><p>&nbsp;</p><p>&nbsp;</p><h3 id='总结-2'><span>总结：</span></h3><p><span>进程同步，用临界区保护信号量（三种方法），信号量在执行过程中语义正确，根据语义可以实现进程在适当的时候阻塞，适当的时候执行，然后用信号量实现同步。</span></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='死锁处理'><span>死锁处理</span></h2><p><span>多个进程由于相互等待对方持有的资源而造成的谁都无法执行的情况叫死锁。</span></p><p>&nbsp;</p><h3 id='死锁的成因'><span>死锁的成因</span></h3><ul><li><span>资源互斥使用，一旦占有别人无法使用</span></li><li><span>进程占有了一些资源，又不释放，再去申请其他资源</span></li><li><span>各自占有的资源和相互申请的资源形成了环路等待</span></li></ul><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220811195254855.png" alt="image-20220811195254855" style="zoom:67%;" /></p><h3 id='死锁的必要条件'><span>死锁的必要条件</span></h3><ul><li><p><span>互斥使用</span></p><ul><li><span>资源的固有特性，如道口</span></li></ul></li><li><p><span>不可抢占</span></p><ul><li><span>资源只能自愿放弃，如车开走以后</span></li></ul></li><li><p><span>请求和保持</span></p><ul><li><span>进程必须占有资源再去申请</span></li></ul></li><li><p><span>循环等待</span></p><ul><li><span>在资源分配图中存在一个环路</span></li></ul></li></ul><p>&nbsp;</p><h3 id='死锁处理方法概述'><span>死锁处理方法概述</span></h3><ul><li><p><span>死锁预防：破环死锁出现的条件</span></p><ul><li><p><span>在进程执行前，一次性申请所有需要的资源，不会占有资源再去申请其他资源</span></p><ul><li><span>缺点1：需要与之未来，编程困难</span></li><li><span>缺点2：许多资源分配后很长时间后才使用，资源利用率低</span></li></ul></li><li><p><span>对资源类型进行排序，资源申请必须按序进行，不会出现环路等待</span></p><ul><li><span>缺点：仍然造成资源浪费</span></li></ul></li></ul></li><li><p><span>死锁避免：检测每个资源请求，如果造成死锁就拒绝</span></p><ul><li><span>如果系统中的所有进程存在一个可完成的执行序列P1,...Pn,则称系统处于安全状态</span></li></ul></li><li><p><span>死锁检测+恢复</span></p><ul><li><span>检测到死锁出现时，让一些进程回滚，让出资源</span></li></ul></li><li><p><span>死锁忽略</span></p><ul><li><span>就好像没有出现死锁一样</span></li></ul></li></ul><p>&nbsp;</p><p>&nbsp;</p><h3 id='死锁避免的银行家算法'><span>死锁避免的银行家算法</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220811202122083.png" alt="image-20220811202122083" style="zoom:50%;" /></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220811202455523.png" alt="image-20220811202455523" style="zoom:50%;" /></p><p><span>Allocation表示进程占用的资源，Need表示进程需要的资源，Available表示当前系统中剩余的资源。</span></p><p><span>如P0占用0个A资源，1个B资源，0个C资源。需要7个A资源，4个B资源，3个C资源才能执行。当前系统中还剩余2个A资源，3个B资源，0个C资源。</span></p><p><span>进程只有得到需要的资源才能执行，执行结束后，进程占用的资源和需要且得到的资源都释放。</span></p><p><span>安全序列为P1,P3,P2,P4,P0</span></p><p>&nbsp;</p><h3 id='死锁检测恢复发现问题再处理'><span>死锁检测+恢复：发现问题再处理</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220811203240137.png" alt="image-20220811203240137" style="zoom:50%;" /></p><p><span>算法效率较高，但是在产生死锁，检测完成后让冲突的进程回滚的难度很大。</span></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h3 id='死锁忽略'><span>死锁忽略</span></h3><p><span>许多通用的操作系统，如PC机上安装的windows和Linux。都采用死锁忽略的方法。原因：</span></p><ul><li><span>死锁忽略的处理代价最小</span></li><li><span>这种机器上出现死锁的概率比其他机器低</span></li><li><span>死锁可以用重启解决，PC重启造成的影响小。</span></li></ul><p>&nbsp;</p><h2 id='内存使用与分段'><span>内存使用与分段</span></h2><p>&nbsp;</p><p><span>内存使用：将程序放在内存中，PC指向开始地址</span></p><h3 id='重定位'><span>重定位</span></h3><p><span>在程序编译形成可执行程序时，程序中指定的地址都是从0开始的相对地址，这个地址通常被成为逻辑地址。当程序载入到物理内存时，可能使用任意一段空闲物理内存，此时为保证程序的顺序执行，就需要进行程序重定位，即将程序中的逻辑地址对应到实际使用的物理内存地址。</span></p><p><span>嵌入式系统可以在编译时重定位。</span></p><p><span>内存重定位后的地址 = 使用的物理内存的起始地址（基地址） + 逻辑偏移地址。</span></p><p>&nbsp;</p><p><span>重定位最合适的时机——运行时重定位</span></p><p><span>在运行每条指令时才完成重定位，每执行一条指令都要从逻辑地址算出物理地址：地址翻译。</span></p><p><span>每个进程的基地址都放在PCB中，执行指令时第一步从PCB中取出这个基地址，然后地址翻译。</span></p><p><span>CS:IP的本质就是 基地址：偏移地址</span></p><p><span>CS：代码段寄存器 IP：指令指针寄存器</span></p><p>&nbsp;</p><p><span>整理：首先将一个程序编译结束，这时每条指令都有自己的逻辑地址。要想让这个程序执行起来，需要创建进程，需要创建PCB，要做的工作就是在内存中找到一段空闲的内存，得到这段空闲内存的起始地址作为基地址存入PCB中，把编译好的程序载入这段空闲内存中，让PC(程序计数器)置好初始地址开始执行。每条指令执行时都要进行地址翻译，找到了这条指令实际使用的物理内存地址，程序就执行起来了。</span></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='引入分段'><span>引入分段</span></h3><p><span>程序是由若干部分（段）组成，每个段分别放入内存，每个段各有各自的特点、用途：代码段只读，代码/数据段不会动态增长，数据段可写。堆栈段可以增长。 </span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220812203457927.png" alt="image-20220812203457927" style="zoom:50%;" /></p><p><span>程序中每一部分指令的偏移量都是从0开始的。</span></p><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220812205437270.png" alt="image-20220812205437270" style="zoom:50%;" /></p><p><span>操作系统的段表叫做GDT表，进程存储基址的段表叫做LDT表.进程切换时，LDT表跟着切换，在执行指令执行时根据LDT进行地址翻译。</span></p><h3 id='引入分段后再看程序执行的过程'><span>引入分段后再看程序执行的过程：</span></h3><p><span>程序在编译时已经将程序分为多个段：代码段，数据段...等等。每个段在内存中找到空闲的地方，把每个段的基址放在LDT表里面，LDT表初始化好之后赋给PCB，然后PC指针设成初始地址开始取指执行。每执行一条指令时都查LDT表，根据表中的段基址进行地址翻译，找到了这条指令实际使用的物理内存地址，然后执行这条指令相应的操作。</span></p><p>&nbsp;</p><h2 id='内存分区与分页'><span>内存分区与分页</span></h2><p>&nbsp;</p><p><span>固定分区（不可取）</span></p><ul><li><span>等分，操作系统初始化时将内存等分为k个分区</span></li></ul><p>&nbsp;</p><p><span>可变分区</span></p><ul><li><span>首先适配O(1),在最先适配的空闲分区分配</span></li><li><span>最佳适配 ：在空闲分区空间大小最接近的分区分配</span></li><li><span>最差适配：在空闲分区空间大小差距最大的空间分配</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><h3 id='引入分页'><span>引入分页</span></h3><p><span>解决内存分区导致的内存效率问题</span></p><p><span>可变分区在经过不断的分区释放分区释放之后，会留下很多很小的分区，这就是内存碎片。在造成总的空间空间大于程序要申请的空间，但是不能分配。</span></p><p><span>解决办法：将空闲分区合并，需要移动一个段（复制内容）：内存紧缩。但是内存紧缩需要花费大量时间。不太行</span></p><p>&nbsp;</p><p><span>将内存分页，针对每个段内存请求，每个段打散成多个页，系统一页一页的分配内存给这个段。每一页的内存都比较小（mem_map的一页内存是4K），就算有一页没有用完，也是浪费很少的空间。</span></p><p>&nbsp;</p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L21_1.png" referrerpolicy="no-referrer" alt="image-20220815110224428"></p><p><span>先得到一个逻辑地址[0x2240]，由于一个系统的每个页面尺寸是4K(0x1000H),要得到页号就是向右移12位。页号为2，在页表中查找该页号对应的页框号， 从而找到这条指令存放的物理地址。</span></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='多级页表和块表'><span>多级页表和块表</span></h2><p><span>为了提高内存空间利用率，页就应该小，但是页小了页表就大了。</span></p><p><span>页表会很大，页表放置就成了问题...</span></p><ul><li><span>页面尺寸通常为4K，而地址是32位的，就有</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1290.1 833.9" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: 0px;"><defs><path id="MJX-13-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-13-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-13-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-13-TEX-N-32"></use><use data-c="30" xlink:href="#MJX-13-TEX-N-30" transform="translate(500,0)"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>20</mn></mrow></msup></math></mjx-assistive-mml></mjx-container><script type="math/tex">2^{20}</script><span>个页面才能索引完全部页面</span></li><li><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1290.1 833.9" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: 0px;"><defs><path id="MJX-13-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-13-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-13-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-13-TEX-N-32"></use><use data-c="30" xlink:href="#MJX-13-TEX-N-30" transform="translate(500,0)"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>20</mn></mrow></msup></math></mjx-assistive-mml></mjx-container><script type="math/tex">2^{20}</script><span>个页表项都得放在程序运行时占用的内存中，如果一个页表项占4b的空间，就需要4M内存；系统中并发10个进程，就需要40M内存</span></li><li><span>实际上大部分逻辑地址（32位：总空间[0,4G]）根本不会用到</span></li></ul><p>&nbsp;</p><p><span>第一次尝试，只存放用到的页</span></p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L22_1.png" alt="image-20220815132039170" style="zoom:50%;" /></p><p><span>用到的逻辑页才有页表项，但是页表中的页号不连续，就需要比较、查找，查找过程中CPU就会通过总线访问内存， 程序执行时间就会变长。就算使用二分查找算法优化也不行。</span></p><p><span>所以页表中的页号必须连续，32位地址空间+4k页面+页号必须连续——&gt;一共有</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1290.1 833.9" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: 0px;"><defs><path id="MJX-13-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-13-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-13-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-13-TEX-N-32"></use><use data-c="30" xlink:href="#MJX-13-TEX-N-30" transform="translate(500,0)"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>20</mn></mrow></msup></math></mjx-assistive-mml></mjx-container><script type="math/tex">2^{20}</script><span>个页表项（32位除以4k）——&gt;会造成大页表占用内存，造成浪费</span></p><p>&nbsp;</p><p>&nbsp;</p><p><span>第二种尝试：多级页表，即页目录表（章）+页表（节）</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815134932872.png" alt="image-20220815134932872" style="zoom:50%;" /></p><p><span>在32位地址空间中，10位表示页目录号即</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1290.1 833.9" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: 0px;"><defs><path id="MJX-16-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-16-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-16-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-16-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-16-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-16-TEX-N-30" transform="translate(500,0)"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>10</mn></mrow></msup></math></mjx-assistive-mml></mjx-container><script type="math/tex">2^{10}</script><span>个页目录，10位表示页表项即</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1290.1 833.9" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: 0px;"><defs><path id="MJX-16-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-16-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-16-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-16-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-16-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-16-TEX-N-30" transform="translate(500,0)"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>10</mn></mrow></msup></math></mjx-assistive-mml></mjx-container><script type="math/tex">2^{10}</script><span>个页表项，12位表示页每页有4K的空间。</span></p><p><span>一个页目录指向</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1290.1 833.9" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: 0px;"><defs><path id="MJX-16-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-16-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-16-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-16-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-16-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-16-TEX-N-30" transform="translate(500,0)"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>10</mn></mrow></msup></math></mjx-assistive-mml></mjx-container><script type="math/tex">2^{10}</script><span>个页表项，每个页表项指向</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="33.689ex" height="2.072ex" role="img" focusable="false" viewBox="0 -833.9 14890.7 915.9" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.186ex;"><defs><path id="MJX-17-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-17-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-17-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-17-TEX-N-2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path><path id="MJX-17-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-17-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path id="MJX-17-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-17-TEX-I-1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-17-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-17-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-17-TEX-N-30" transform="translate(500,0)"></use></g></g></g><g data-mml-node="mo" transform="translate(1512.3,0)"><use data-c="2217" xlink:href="#MJX-17-TEX-N-2217"></use></g><g data-mml-node="msup" transform="translate(2234.6,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-17-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-17-TEX-N-31"></use><use data-c="32" xlink:href="#MJX-17-TEX-N-32" transform="translate(500,0)"></use></g></g></g><g data-mml-node="mo" transform="translate(3802.4,0)"><use data-c="3D" xlink:href="#MJX-17-TEX-N-3D"></use></g><g data-mml-node="mn" transform="translate(4858.2,0)"><use data-c="31" xlink:href="#MJX-17-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-17-TEX-N-30" transform="translate(500,0)"></use><use data-c="32" xlink:href="#MJX-17-TEX-N-32" transform="translate(1000,0)"></use><use data-c="34" xlink:href="#MJX-17-TEX-N-34" transform="translate(1500,0)"></use></g><g data-mml-node="mo" transform="translate(7080.4,0)"><use data-c="2217" xlink:href="#MJX-17-TEX-N-2217"></use></g><g data-mml-node="mn" transform="translate(7802.7,0)"><use data-c="34" xlink:href="#MJX-17-TEX-N-34"></use></g><g data-mml-node="mo" transform="translate(8524.9,0)"><use data-c="2217" xlink:href="#MJX-17-TEX-N-2217"></use></g><g data-mml-node="mn" transform="translate(9247.1,0)"><use data-c="31" xlink:href="#MJX-17-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-17-TEX-N-30" transform="translate(500,0)"></use><use data-c="32" xlink:href="#MJX-17-TEX-N-32" transform="translate(1000,0)"></use><use data-c="34" xlink:href="#MJX-17-TEX-N-34" transform="translate(1500,0)"></use></g><g data-mml-node="mo" transform="translate(11524.9,0)"><use data-c="3D" xlink:href="#MJX-17-TEX-N-3D"></use></g><g data-mml-node="mn" transform="translate(12580.7,0)"><use data-c="34" xlink:href="#MJX-17-TEX-N-34"></use></g><g data-mml-node="mi" transform="translate(13080.7,0)"><use data-c="1D440" xlink:href="#MJX-17-TEX-I-1D440"></use></g><g data-mml-node="mi" transform="translate(14131.7,0)"><use data-c="1D435" xlink:href="#MJX-17-TEX-I-1D435"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>10</mn></mrow></msup><mo>∗</mo><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>12</mn></mrow></msup><mo>=</mo><mn>1024</mn><mo>∗</mo><mn>4</mn><mo>∗</mo><mn>1024</mn><mo>=</mo><mn>4</mn><mi>M</mi><mi>B</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">2^{10}*2^{12} = 1024*4*1024 = 4MB</script><span>的空间。在实际的程序运行过程中，程序只需要查找指令所在的页目录以及页目录对应的页表，所以页目录索引表占用的空间就是</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="11.514ex" height="2.072ex" role="img" focusable="false" viewBox="0 -833.9 5089.1 915.9" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.186ex;"><defs><path id="MJX-18-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-18-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-18-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-18-TEX-N-2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path><path id="MJX-18-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path id="MJX-18-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-18-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-18-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-18-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-18-TEX-N-30" transform="translate(500,0)"></use></g></g></g><g data-mml-node="mo" transform="translate(1512.3,0)"><use data-c="2217" xlink:href="#MJX-18-TEX-N-2217"></use></g><g data-mml-node="mn" transform="translate(2234.6,0)"><use data-c="34" xlink:href="#MJX-18-TEX-N-34"></use></g><g data-mml-node="mo" transform="translate(3012.3,0)"><use data-c="3D" xlink:href="#MJX-18-TEX-N-3D"></use></g><g data-mml-node="mn" transform="translate(4068.1,0)"><use data-c="34" xlink:href="#MJX-18-TEX-N-34"></use></g><g data-mml-node="mi" transform="translate(4568.1,0)"><use data-c="1D458" xlink:href="#MJX-18-TEX-I-1D458"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>10</mn></mrow></msup><mo>∗</mo><mn>4</mn><mo>=</mo><mn>4</mn><mi>k</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">2^{10}*4 = 4k</script><span>，一个页表号占4个字节,用到的三条页目录各自还需要存储一个页表，每个4K,所以一共需要16k的空间用来索引指令所在的物理地址。远小于4M。</span></p><p>&nbsp;</p><p><span>多级页表增加了访存的次数，尤其是64位系统。多级页表每增加一级，内存的节省会更多，但是内存的访问次数会增加。</span></p><p><span>TLB（快表）是一组相联快速存储，是寄存器。通过设计电路，根据页号一次比对直接找到物理地址。</span></p><p><span>快表查不到再去多级页表查</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815152018035.png" alt="image-20220815152018035" style="zoom:50%;" /></p><ul><li><span>TLB命中时效率会很高，未命中时效率降低。</span></li><li><span>要想真正实现“近似访存一次”，TLB的命中率应该很高</span></li><li><span>TLB越大越好，但TLB很贵，通常只有[64,1024]</span></li><li><span>而且TLB不是固定不变的，还需要一定的置换策略。</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><h2 id='段页结合的实际内存管理'><span>段页结合的实际内存管理</span></h2><p><span>程序员希望用段，物理内存希望用页。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815155816408.png" alt="image-20220815155816408" style="zoom:50%;" /></p><ul><li><span>程序员编写的程序在编译过程中会被分成几个段。在虚拟内存中分割出一些分区，将程序的各个段“放入”，分区分割算法可以使用前面论述过的适配算法。由于虚拟内存并没有对应真实存储单元，所以这里并不是真的放入，而是建立映射关系，假装放入。</span></li><li><span>建立表段记录程序各段和虚拟分区之间的映射关系。</span></li><li><span>将虚拟内存分割成页，选择物理内存中的空闲页框，将虚拟内存中的“页内容”放到物理页框中。由于虚拟内存是不存放实例内容的假内存，所以这里的页内容实际上是曾静假装放入虚拟内存的程序段内容。</span></li><li><span>因此,基于虚拟内存的段页结合效果是将程序段分割成页以后载入物理页框中,但是这个载入是通过虚拟内存才完成的。一旦经过了虚拟内存,从用户出发看到的视图是程序段被放到一个连续“内存”区域上,即用户看到的是分段效果。在背后,操作系统再将这个“内存”区域按照分页方式真正放到物理内存里,实现了分页机制。 </span></li></ul><p>&nbsp;</p><h3 id='段页同时存在时的重定位地址翻译）'><span>段、页同时存在时的重定位（地址翻译）</span></h3><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L23_2.png" referrerpolicy="no-referrer" alt="image-20220815161137856"></p><p><span>经过两层地址翻译：</span></p><p><span>第一层地址翻译是基于段的地址翻译，支持分段。首先通过段表找到一个地址，是一个虚拟地址。</span></p><p><span>第二层地址翻译是基于页的地址翻译，支持分页。从虚拟地址算出页号，根据页号得到物理地址的页框号，根据页框号加页内偏移得到真正的物理地址。</span></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h2 id='内存换入'><span>内存换入</span></h2><p><span>虚拟内存就是操作系统给进程提供的一个规整的、总长度总为4GB(32位操作系统)的地址空间,用户可以随意访问这个空间中的任何一个地址。但是由于实际的物理内存可能比4GB要小,所以4GB的虚拟内存不可能全部映射到物理内存上，这就会产生如图7.1所示的换入/换出场景,首先访问左图中阴影部分的那段虚存区域,虚存区域和物理内存建立了关联,现在又要访问右图阴影部分的那段虚存区域,由于当前剩余物理内存空间不足,需要首先将物理内存中的某些关联释放掉(换出),在物理内存中腾出的地方上和右图中的虚存区域建立关联(换入)。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815164326924.png" alt="image-20220815164326924" style="zoom: 67%;" /></p><h3 id='内存换入从缺页开始'><span>内存换入从缺页开始</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815165821588.png" alt="image-20220815165821588" style="zoom:50%;" /></p><p><span>一个程序访问线性地址，发现缺页，因为这一页虚拟内存区域还没有和物理内存建立关联。内存换入的核心就是在缺少虚拟页的时候请求调页，操作系统实现换入就是请求调页。</span></p><p><span>对应图中的步骤</span></p><ol start='' ><li><span>请求调页的整个过程从 MMU发现虚拟页面在页表项中的有效位为0时开始，</span></li><li><span>这个时候MMU会向CPU 发出缺页中断。</span></li><li><span>操作系统的内存换入就从这个缺页中断开始,在这个中断处理中操作系统会去磁盘(仓库)上找到这个虚拟页(商品)</span></li><li><span>并将这个虚拟页从磁盘上读进来。当然在读进来之前先要找到一个空闲的物理内存页框(店面中的一个柜台),再将那个虚拟页读到空闲页框以后(将商品放在柜台上),</span></li><li><span>虚拟页面就和物理页框建立关联了,再更新页表来记下这个映射关系(告诉售货员商品放在哪里了)。</span></li></ol><p>&nbsp;</p><p>&nbsp;</p><h2 id='内存换出'><span>内存换出</span></h2><p><span>由于物理内存是有限的，且相比虚拟内存而言要小得多，因此我们不能一直换入页面。从磁盘换入虚拟页面时，需要在物理内存中找到一个空闲页框，但这个空闲内存页框不一定总能找到。所以更符合实例的做法应该是，如果能找到物理内存页框就直接读入虚拟页，否则就要进行内存换出。由此可知，内存换入和换出必须配合在一起才能实现虚拟内存。</span></p><p>&nbsp;</p><p><span>页面换出要解决的基本问题就是选择哪个页面进行淘汰。</span></p><p>&nbsp;</p><h3 id='fifo页面置换'><span>FIFO页面置换</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815192547642.png" alt="image-20220815192547642" style="zoom: 50%;" /></p><h3 id='min页面置换'><span>MIN页面置换</span></h3><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L25_2.png" alt="image-20220815192652659" style="zoom:50%;" /></p><p><span>MIN页面置换，需要预知将来，但计算机不能预知未来。</span></p><p>&nbsp;</p><h3 id='lru页面置换'><span>LRU页面置换</span></h3><p><span>least recent used 最近最少使用</span></p><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L25_3.png" alt="image-20220815193243152" style="zoom: 50%;" /></p><p>&nbsp;</p><h3 id='lru实现'><span>LRU实现</span></h3><p>&nbsp;</p><ol start='' ><li><span>这里的关键是维护时机的问题。</span></li><li><span>如果不缺页，程序应该是直接通过MMU访问物理地址，内核没有机会进行时间戳或者栈的维护。</span></li><li><span>只有在缺页中断的时候内核才有机会接触处理页换出。</span></li><li><span>任何在不缺页的时候的数据结构维护都会带来巨大开销</span></li></ol><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815193542059.png" alt="image-20220815193542059" style="zoom:50%;" /></p><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815194643329.png" alt="image-20220815194643329" style="zoom:50%;" /></p><p>&nbsp;</p><h3 id='lru近似实现'><span>LRU近似实现</span></h3><p><span>将时间计数变为是和否</span></p><ul><li><p><span>每个页加一个引用位</span></p><ul><li><span>每个访问一页时，硬件自动设置该位</span></li><li><span>缺页时选择淘汰页：扫描该位，是1时清0，并继续扫描；是0时淘汰该页</span></li></ul></li></ul><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815195657668.png" alt="image-20220815195657668" style="zoom:50%;" /></p><p><span>SCR算法又被称为CLOCK算法</span></p><p>&nbsp;</p><h3 id='clock算法的分析与改造'><span>Clock算法的分析与改造</span></h3><p><span>如果缺页很少的话，R就全等于1，指针扫描一圈后淘汰当前页，将调入页插入到当前位置，指针前移一位。这样就退化位FIFO算法。原因：记录了太长的历史信息,没法表达最近。解决办法：再加一个扫描指针来清楚R位，让R位从1置成0。快指针页的R位置为0，慢指针查看R位发现R位为0时，表示该页在最近一段时间没有被使用，就选择淘汰该页。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815200556721.png" alt="image-20220815200556721" style="zoom:50%;" /></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815201540992.png" alt="image-20220815201540992" style="zoom:50%;" /></p><p><span>   </span><strong><span>系统颠簸的根本原因</span></strong><span>就是给进程分配的物理页框数量太少,少到无法覆盖当前进程执行时的“局部”,导致换出去的页面又立刻会被程序访问,需要换入;当然将需要的页面换入又造成某个即将被再次访问页面换出,如此不断往复….、系统颠簸就开始了。</span></p><p><span>解决系统颠簸也并不难,只要计算出进程当前执行需要覆盖的局部是多大,操作系统保证分配该进程的物理页框数量大于其局部即可,如果系统的空闲内存不足,就将某些进程挂起,将其换出到磁盘上,腾出地方来保证分配给每个进程的物理页框个数足够覆盖其局部。</span></p><p><span>显然这里的关键问题是如何估计其当前局部有多大。工作集模型(working set model)就是解决这个问题的数学方法。工作集的核心时统计进程在最近一个历史窗口△中访问了哪些页，这些页形成的集合就被称为工作集。</span></p><p><span>显然,工作集模型的关键在于恰当地设定△,如果△太大,工作集会覆盖多个局部,造成内存的浪费;如果△太小,工作集又可能覆盖不住局部,造成系统颠簸。在实际系统中,△通常是要随着某些系统参数而自适应调整的,例如,如果发现最近一段时间系统整体缺页率偏高,则应该将△增大,因为缺页增多很可能是由于没有很好地覆盖局部而造成的;反之,将△调小,这样就可以腾出一些内存空间,让更多的进程进入内存,提高并发度。</span></p><p>&nbsp;</p><h3 id='内存换入换出总结'><span>内存换入换出总结</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815203124212.png" alt="image-20220815203124212" style="zoom:50%;" /></p><ol start='' ><li><span>请求调页的整个过程从 MMU发现虚拟页面在页表项中的有效位为0时开始，</span></li><li><span>这个时候MMU会向CPU 发出缺页中断。</span></li><li><span>操作系统的内存换入就从这个缺页中断开始,在这个中断处理中操作系统会去磁盘(仓库)上找到这个虚拟页(商品)</span></li><li><span>并将这个虚拟页从磁盘上读进来。当然在读进来之前先要找到一个空闲的物理内存页框(店面中的一个柜台),再将那个虚拟页读到空闲页框以后(将商品放在柜台上),</span></li><li><span>这时空闲物理内存页框可能不足，就需要进行swap分区内存换出，用Clock淘汰一个页面，得到一个空闲内存，再从swap分区进行内存换入。</span></li><li><span>虚拟页面就和物理页框建立关联了,再更新页表来记下这个映射关系(告诉售货员商品放在哪里了)。</span></li></ol><p>&nbsp;</p><h3 id='内存管理总结'><span>内存管理总结</span></h3><p><span>内存的换入换出是实现虚拟内存的核心，实现虚拟内存又是为了实现段页，实现段页就是实现操作系统管理内存的思想，管理内存是为了实现程序能够载入，程序能够执行起来，程序执行起来就是进程。</span></p><p>&nbsp;</p><h2 id='外设管理'><span>外设管理</span></h2><p><span>核心：一是从文件读写到设备命令，二是从设备驱动再回到文件读写。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220817145152048.png" alt="image-20220817145152048" style="zoom: 50%;" /></p><p>&nbsp;</p><p><span>计算机外设的工作原理,即CPU对外设的使用主要由如下两条主线构成:第一条主线是从CPU开始,CPU发送命令给外设,最终表现为CPU执行指令“out ax,端口号”;第二条主线是从外设开始,外设在完成工作后或出现状态变化时通过中断通知CPU,CPU通过中断处理程序完成后续工作。</span><strong><span>主要就是三件事，形成文件视图，发出out指令，形成中断处理。</span></strong></p><p><span>第一条主线的主题词是“发出命令”,第二条主线的主题词是“中断处理”,两条主线统一在图中。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815205501929.png" alt="image-20220815205501929" style="zoom: 80%;" /></p><p><span>每一个外设都有一个设备控制器，比如显示器有一个显卡，cpu让外设工作起来就是给外设的设备控制器的寄存器中写内容，控制器就会根据寄存器里面的内容实际的来操控外设，对外设的操控结束后，外设会向CPU发送中断，然后CPU处理中断。</span></p><p>&nbsp;</p><h3 id='一段操作外设的程序'><span>一段操作外设的程序</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">fd</span> <span class="cm-operator">=</span> <span class="cm-variable">open</span>(<span class="cm-string">"/dev/xxx"</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">10</span>;<span class="cm-variable">i</span><span class="cm-operator">++</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">write</span>(<span class="cm-variable">fd</span>,<span class="cm-variable">i</span>,<span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">int</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">close</span>(<span class="cm-variable">fd</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 136px;"></div><div class="CodeMirror-gutters" style="display: none; height: 136px;"></div></div></div></pre><p><span>（1）不论什么设备都是open,read,write,close操作系统为用户提供统一的接口。</span></p><p><span>（2）不同的设备对应不同的设备文件(/dev/xxx),根据设备文件找到控制器的地址、内容格式等等</span></p><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220815211939921.png" alt="image-20220815211939921" style="zoom:50%;" /></p><p>&nbsp;</p><h3 id='从文件读写到设备命令显示器驱动'><span>从文件读写到设备命令：显示器驱动</span></h3><p><code>printf(&quot;Host Name:%s,name&quot;);</code></p><p><span>printf库展开的部分，先创建缓存buf将格式化输出都写到那里，然后再write(1,buf,...)</span></p><p><span> </span><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220817114113806.png" alt="image-20220817114113806" style="zoom: 67%;" /></p><p><span> 要想输出字符串到显示器上，需要使用printf函数，printf是一个库函数，该库函数会将%d,%c等内容统一处理为字符串，然后以该字符串所在的内存地址buf和字符串长度count为参数调用系统调用write(1,buf,count)。write的内核实现是sys_write中断，所以printf的下一步就是sys_write。而sys_write首先要找到所写文件的属性，判断是设备文件还是普通文件。因为显示器是设备文件，sys_write要根据设备文件中存放的</span><strong><span>设备属性</span></strong><span>信息转到相应的操作命令。设备信息存放在文件本身的FCB中。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">在Linux</span><span class="cm-operator">/</span><span class="cm-variable">fs</span><span class="cm-operator">/</span><span class="cm-variable">read_write</span>.<span class="cm-variable">c中</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//fd文件描述符（数组下标）-&gt;filp是进程的文件描述符表（数组） filp[fd] 就指向file（文件表）文件表的f_inode字段指向该文件的inode节点，包含文件的元数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">sys_write</span>(<span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">int</span> <span class="cm-variable">fd</span>,<span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">buf</span>,<span class="cm-variable-3">int</span> <span class="cm-variable">count</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">struct</span> <span class="cm-def">file</span><span class="cm-operator">*</span> <span class="cm-variable">file</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-variable">current</span><span class="cm-operator">-&gt;</span><span class="cm-variable">filp</span>[<span class="cm-variable">fd</span>];<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//current表示当前进程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">inode</span> <span class="cm-operator">=</span> <span class="cm-variable">file</span><span class="cm-operator">-&gt;</span><span class="cm-variable">f_inode</span>;<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//file的目的就是得到inode，显示器信息应该就在这里</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="display: none; height: 204px;"></div></div></div></pre><p><span>为找到“文件”FCB,首先要做的工作就是从当前进程 PCB中找到打开文件的句柄标识，即fd。</span></p><p><code>current-&gt;filp</code><span>中存放了当前进程打开的文件，如果一个文件不是当前进程打开的，那么就一定是其父进程打开后再由子进程继承来的，这是UNIX类操作系统执行fork的结果。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//进程创建的代码片段（复制父进程文件句柄）</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">copy_process</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">*</span><span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span><span class="cm-variable">current</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span>(<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">NR_OPEN</span>;<span class="cm-variable">i</span><span class="cm-operator">++</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>((<span class="cm-variable">f</span><span class="cm-operator">=</span><span class="cm-variable">p</span><span class="cm-operator">-&gt;</span><span class="cm-variable">filp</span>[<span class="cm-variable">i</span>])) <span class="cm-variable">f</span><span class="cm-operator">-&gt;</span><span class="cm-variable">f_count</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>.......<span class="cm-tab" role="presentation" cm-text="	"> </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 181px;"></div><div class="CodeMirror-gutters" style="display: none; height: 181px;"></div></div></div></pre><p><span>因为每个进程都可能用到标准输出,所以每个进程都会打开这个文件。既然所有进程都要打开这个设备文件,操作系统初始化时的1号进程会首次打开这个设备文件,然后其他进程继承这个文件句柄。在系统启动后创建1号进程的地方,即在init函数中调用open来打开一个名为“/dev/tty0”的文件,由于这是该进程打开的第一个文件,所以对应的文件句柄fd =0,接下来调用了两次dup,使得fd = 1, fd = 2也都指向了“/dev/tty0”的 FCB,所以fd = 1的文件对应标准输出。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//系统初始化代码片段（打开tty设备）</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">main</span>(<span class="cm-variable-3">void</span>) {<span class="cm-keyword">if</span>(<span class="cm-operator">!</span><span class="cm-variable">fork</span>()) <span class="cm-variable">init</span>();}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">init</span>(<span class="cm-variable-3">void</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">open</span>(<span class="cm-string">"/dev/tty0"</span>,<span class="cm-variable">O_RDWR</span>,<span class="cm-number">0</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//打开设备文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">dup</span>(<span class="cm-number">0</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//复制文件句柄</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">dup</span>(<span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">execve</span>(<span class="cm-string">"/bin/sh"</span>,<span class="cm-variable">argv</span>,<span class="cm-variable">envp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>......</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 227px;"></div><div class="CodeMirror-gutters" style="display: none; height: 227px;"></div></div></div></pre><p><span>对于显示器而言,这个fd = 1,然后根据这个fd可以找到文件 FCB,即代码中的inode。现在显示器对应的设备文件已经找到了,就是文件“/dev/tty0”,其属性信息也已经存放在sys_write函数中的inode变量中了,sys_write就可以继续工作了。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//sys_write代码片段（根据文件属性进行分支）</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">sys_write</span>(<span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">int</span> <span class="cm-variable">fd</span>,<span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">buf</span>,<span class="cm-variable-3">int</span> <span class="cm-variable">cnt</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">S_ISCHR</span>(<span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_mode</span>))<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//根据inode中的信息判断该文件对应的设备是否是一个字符设备</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">rw_char</span>(<span class="cm-variable">WRITE</span>,<span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_zone</span>[<span class="cm-number">0</span>],<span class="cm-variable">buf</span>,<span class="cm-variable">cnt</span>);<span class="cm-comment">//显示器是一个字符设备，执行rw_char函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>......</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 159px;"></div><div class="CodeMirror-gutters" style="display: none; height: 159px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//字符设备处理代码</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//rw_cahr中以主设备号(MAJOR(dev))为索引从一个函数表crw_table中查找和中断设备对应的读写函数rw_ttyx,然后调用这个函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">rw_char</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">rw</span>,<span class="cm-variable-3">int</span> <span class="cm-variable">dev</span>,<span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">buf</span>,<span class="cm-variable-3">int</span> <span class="cm-variable">cnt</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">crw_ptr</span> <span class="cm-variable">call_addr</span> <span class="cm-operator">=</span> <span class="cm-variable">crw_table</span>[<span class="cm-variable">MAJOR</span>(<span class="cm-variable">dev</span>)];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">call_addr</span>(<span class="cm-variable">rw</span>,<span class="cm-variable">dev</span>,<span class="cm-variable">buf</span>,<span class="cm-variable">cnt</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">crw_ptr</span> <span class="cm-variable">crw_table</span>[] <span class="cm-operator">=</span> {.....,<span class="cm-variable">rw_ttyx</span>,...};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//函数rw.ttyx 中根据是设备读操作还是设备写操作继续分支。显示器和键盘合在一起构成了终端设备tty，显示器只写,键盘只读。此处是显示器,所以对应写操作,将调用函数 tty.write(minor,buf)。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">rw_ttyx</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">rw</span>,<span class="cm-variable-3">unsigned</span> <span class="cm-variable">minor</span>,<span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">buf</span>,<span class="cm-variable-3">int</span> <span class="cm-variable">count</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> ((<span class="cm-variable">rw</span><span class="cm-operator">==</span><span class="cm-variable">READ</span>))<span class="cm-operator">?</span><span class="cm-variable">tty_read</span>(<span class="cm-variable">minor</span>,<span class="cm-variable">buf</span>):<span class="cm-variable">tty_write</span>(<span class="cm-variable">minor</span>,<span class="cm-variable">buf</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>.........</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 408px;"></div><div class="CodeMirror-gutters" style="display: none; height: 408px;"></div></div></div></pre><p><span>根据文件的属性,即 inode 中的信息,经过大量分支以后,从写文件 write最终到达真正操作显示器的 tty.write。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//tty-write 核心代码(将显示字符放到缓冲队列)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">tty_write</span>(<span class="cm-variable-3">unsigned</span> <span class="cm-variable">channel</span> , <span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">buf</span> ,<span class="cm-variable-3">int</span> <span class="cm-variable">nr</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">tty_struct</span> <span class="cm-operator">*</span><span class="cm-variable">tty</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">tty</span> <span class="cm-operator">=</span> <span class="cm-variable">channel</span><span class="cm-operator">+</span><span class="cm-variable">tty_table</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">sleepif</span>.<span class="cm-variable">full</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">write_q</span>);<span class="cm-comment">//在结构体tty_struct中找到队列tty_write_q</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">char</span> <span class="cm-variable">c，</span><span class="cm-operator">*</span><span class="cm-variable">b</span><span class="cm-operator">=</span><span class="cm-variable">buf</span> ;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//输出到显示器就是输出到write_q队列中，缓冲队列</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">while</span>(<span class="cm-variable">nr</span><span class="cm-operator">&gt;</span><span class="cm-number">0</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">!</span><span class="cm-variable">FULL</span>(<span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">write_q</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">get</span> <span class="cm-variable">fs</span><span class="cm-operator">-</span><span class="cm-variable">byte</span>(<span class="cm-variable">b</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">c</span><span class="cm-operator">==</span><span class="cm-string">'r'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">PUTCH</span>(<span class="cm-number">13</span>,<span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">write_q</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">continue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">OLCUC</span>(<span class="cm-variable">tty</span>)) <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">toupper</span>(<span class="cm-variable">c</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">PUTCH</span>(<span class="cm-variable">c</span>,<span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">write_q</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">b</span><span class="cm-operator">++</span>; <span class="cm-variable">nr</span><span class="cm-operator">--</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }<span class="cm-operator">/</span> <span class="cm-operator">/</span><span class="cm-variable">输出完成或写队列满</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">write</span>(<span class="cm-variable">tty</span>);<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//将队列内容写到显示器上</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 521px;"></div><div class="CodeMirror-gutters" style="display: none; height: 521px;"></div></div></div></pre><p><span>tty_write用到了缓冲机制。缓冲是指两个速度存在差异的设备之间通过缓冲队列来弥补这种差异的一种方式,具体而言,就是高速设备将数据存到缓冲队列中,然后高速设备去做其他事,低速设备在合适的时候从缓冲队列中取走内容进行输出,这样高速设备不必一直同步等待低速设备,提高了系统的整体效率。在这里,高速设备就是CPU,低速设备就是显示器。缓冲机制是操作系统在外设管理时经常使用的基本机制。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//tty结构体的初始化为</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">tty_struct</span> <span class="cm-def">tty_table</span>[] <span class="cm-operator">=</span> {{<span class="cm-variable">con_write</span>,{<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-string">" "</span> },{<span class="cm-number">0</span>,<span class="cm-number">0</span> ,<span class="cm-variable">o</span>,<span class="cm-number">0</span>, <span class="cm-string">" "</span>},{},..};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//由此可知，tty_write调用的函数时con_write</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-variable">con_write</span>(<span class="cm-keyword">struct</span> <span class="cm-def">tty_struct</span> <span class="cm-operator">*</span><span class="cm-variable">tty</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">GETCH</span>(<span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">writeq</span>, <span class="cm-variable">c</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">c</span><span class="cm-operator">&gt;</span><span class="cm-number">31</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">c</span><span class="cm-operator">&lt;</span><span class="cm-number">127</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">__asm__</span>( <span class="cm-string">"movb attr，%%ah"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"movw %%ax,%1"</span> ::<span class="cm-string">" a"</span>(<span class="cm-variable">c</span>), <span class="cm-string">" m”(*(short*)pos) : "</span><span class="cm-variable">ax</span><span class="cm-string">");</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">pos</span><span class="cm-operator">+=</span><span class="cm-number">2</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//con_write核心代码是一段嵌入式汇编代码,具体完成的工作是:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mov</span> <span class="cm-variable">c，</span> <span class="cm-variable">al</span><span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//将要输出的字符放在寄存器AX的低八位</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mov</span> <span class="cm-variable">attr，ah</span><span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//将显示属性attr放在寄存器AX的高8位</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mov</span> <span class="cm-variable">ax，</span>[<span class="cm-variable">pos</span>]<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//将AX输出到地址pos处，pos就是开机以后光标当前所在的显存位置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//显示器输出工作最终到了"out"指令，这里"out"指令和"mov"指令没有区别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 453px;"></div><div class="CodeMirror-gutters" style="display: none; height: 453px;"></div></div></div></pre><p><span>pos就是开机以后当前光标所在的显存位置</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//pos （光标位置)的初始化代码</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">con_init</span>(<span class="cm-variable-3">void</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">gotoxy</span>(<span class="cm-variable">ORIGX</span>,<span class="cm-variable">ORIG_Y</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">inline</span> <span class="cm-variable-3">void</span> <span class="cm-def">gotoxy</span>(<span class="cm-variable">x，</span> <span class="cm-variable">y</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">pos</span><span class="cm-operator">=</span> <span class="cm-variable">origin</span><span class="cm-operator">+</span><span class="cm-variable">y</span><span class="cm-operator">*</span><span class="cm-variable">videosizerow</span> <span class="cm-operator">+</span>(<span class="cm-variable">x</span><span class="cm-operator">&lt;&lt;</span><span class="cm-number">1</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-comment">//origin是显存在内存中的初始位置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//在系统启动的setup.s时利用BIOS中断将当前光标的行、列位置取出来放到了0x90001，0x90000处</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define ORIGX(*(unsigned char*)0x90000)</span><span class="cm-comment">//初始光标列号</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define ORIGY (*(unsigned char*)0x90001)</span><span class="cm-comment">//初始光标行号</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 295px;"></div><div class="CodeMirror-gutters" style="display: none; height: 295px;"></div></div></div></pre><p>&nbsp;</p><h3 id='总结-3'><span>总结</span></h3><p><span>到了这里，printf → write → sys_write → rw_char → rw_ttyx → tty_write → write_q →con_write →“mov ax,[pos]”,这条从printf到“mov ax,[pos]”的文件视图路线就完整了。</span></p><p><span>printf调用的是write系统调用，引起sys_write系统中断，判断设备信息，显示器是字符设备，调用rw_char;显示器是只写设备，调用tty_write;利用缓冲机制把字符先保存在缓冲队列write_q中，然后使用con_write函数用mov指令输出到显示器。</span></p><p>&nbsp;</p><h3 id='从设备驱动到文件读写键盘'><span>从设备驱动到文件读写：键盘</span></h3><p><span>键盘按下会产生0x21号中断，所以整个故事从0x21号中断处理函数开始。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//键盘中断初始化代码</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-variable">con</span>.<span class="cm-variable">init</span>(<span class="cm-variable-3">void</span>) { <span class="cm-variable">set_trap_gate</span>(<span class="cm-variable">Ox21，</span><span class="cm-operator">&amp;</span><span class="cm-variable">keyboard_interrupt</span>);}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">keyboardinterrupt</span> :</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">inb</span> <span class="cm-variable">$ox60</span> , <span class="cm-operator">%</span><span class="cm-variable">al</span><span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//从端口0x60读扫描码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">call</span> <span class="cm-def">key_table</span>( , <span class="cm-operator">%</span><span class="cm-variable">eax</span> ,<span class="cm-number">4</span>)<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//根据扫描码调用不同的处理函数来处理各个案件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ......</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">push</span> <span class="cm-variable">$0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">call</span> <span class="cm-variable">do_tty_interrupt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="display: none; height: 204px;"></div></div></div></pre><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">key_table</span>:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>.<span class="cm-variable-3">long</span> <span class="cm-variable">none</span>,<span class="cm-variable">do_self</span>,<span class="cm-variable">do_self</span>,<span class="cm-variable">do_self</span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//对应扫描码 00~03</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>.<span class="cm-variable-3">long</span> <span class="cm-variable">do_self</span>,...,<span class="cm-variable">func</span>,<span class="cm-variable">scroll</span>,<span class="cm-variable">cursor</span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//绝大多数按键（如字母键、数字键等）都用do_self函数处理</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 113px;"></div><div class="CodeMirror-gutters" style="display: none; height: 113px;"></div></div></div></pre><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">do_self:</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">lea</span> <span class="cm-keyword">alt_map</span>,%<span class="cm-variable-2">ebx</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">testb</span> $0x20,mode<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//检测alt键是否同时按下</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">jne</span> <span class="cm-keyword">1f</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">lea</span> <span class="cm-keyword">shift_map</span>,%<span class="cm-variable-2">ebx</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">testb</span> $0x03,mode<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//检测shift键是否同时按下</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">jne</span> <span class="cm-keyword">1f</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">lea</span> <span class="cm-keyword">key_map</span>，%<span class="cm-variable-2">ebx</span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//找到映射表，如a的key_map映射为a，而shift_map映射为A</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">//映射表</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#if defined(KBD_US)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">key_map:</span> <span class="cm-builtin">.byte</span> 0,27 <span class="cm-builtin">.ascii</span> <span class="cm-string">"1234567890-="</span>...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">shift_map:</span> <span class="cm-builtin">.byte</span> 0,27 <span class="cm-builtin">.ascii</span> <span class="cm-string">"!@#$%^&amp;*()_+"</span>...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#elif defined(KBD_GR)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">//继续执行do_self,从1f开始，<span class="cm-variable-2">ebx</span>放的是map起始地址 ,<span class="cm-variable-2">eax</span>是对应的扫描码</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">1:</span>  movb (%<span class="cm-variable-2">ebx</span>，%<span class="cm-variable-2">eax</span>), %al<span class="cm-tab" role="presentation" cm-text="	">   </span>//以扫描码为索引，将按键对应的 ASCII码放入al</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">orb</span> %al,%al<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//没有对应的ASCII码</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">je</span> <span class="cm-keyword">none</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">testb</span> $0x4c,mode<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//看caps是否点亮</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">je</span> <span class="cm-keyword">2f</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">cmpb</span> $'a,%al'<span class="cm-tab" role="presentation" cm-text="	">   </span>jb 2f</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">cmpb</span> $'<span class="cm-braket">}</span>,%al' &nbsp; ja 2f</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">subb</span> $32,%al<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//变大写</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">2:</span><span class="cm-tab" role="presentation" cm-text="	">  </span>testb $??,mode<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//处理其他模式，如ctrl同时按下</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">3:</span><span class="cm-tab" role="presentation" cm-text="	">  </span>andl $0xff,%<span class="cm-variable-2">eax</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">call</span> <span class="cm-keyword">put_queue</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">none:</span><span class="cm-keyword">ret</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 635px;"></div><div class="CodeMirror-gutters" style="display: none; height: 635px;"></div></div></div></pre><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tag">put_queue:</span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//把得到的ASCII码放到队列里面<span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">movl</span> <span class="cm-builtin">_table_list</span>，%<span class="cm-variable-2">edx</span><span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//得到队列<span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">movl</span> <span class="cm-keyword">head</span>(%<span class="cm-variable-2">edx</span>) , %<span class="cm-variable-2">ecx</span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span>//得到read_q的head字段</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">1:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">movb</span> %al , buf(%<span class="cm-variable-2">edx</span>,%<span class="cm-variable-2">ecx</span>)<span class="cm-tab" role="presentation" cm-text="	">   </span>//将ASCII码放在队列head字段<span class="cm-tab" role="presentation" cm-text="	"> </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-keyword">tty_queue</span> *table_list[] <span class="cm-tag">=</span><span class="cm-braket">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  &amp;ttytable[0].read_q<span class="cm-comment">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  &amp;tty-table[0].write_q<span class="cm-comment">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-braket">}</span><span class="cm-comment">;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 227px;"></div><div class="CodeMirror-gutters" style="display: none; height: 227px;"></div></div></div></pre><p>&nbsp;</p><h3 id='回显'><span>回显</span></h3><p><span>按下键盘时，可显示的字符通常还要回显。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">do_tty_interrupt</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">tty</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{ <span class="cm-variable">copy</span> <span class="cm-variable">to_cooked</span>(<span class="cm-variable">tty_table</span><span class="cm-operator">+</span><span class="cm-variable">tty</span>); }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//copy .to_cooked具体要做的工作就是从read_q队列中取出字符(GETCH(tty-&gt;readq,c))并将该字符放在 tty-&gt;secondary队列中(PUTCH(c,tty-&gt;secondary))，同时唤醒等待这个队列上的进程(wake_up(&amp;tty-&gt;secondary.proclist))。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">copy_to_cooked</span>(<span class="cm-keyword">struct</span> <span class="cm-def">tty_struct</span> <span class="cm-operator">*</span><span class="cm-variable">tty</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">GETCH</span>(<span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">read_q</span>,<span class="cm-variable">c</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">L_ECHO</span>(<span class="cm-variable">tty</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">PUTCH</span>(<span class="cm-variable">c</span>,<span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">write_q</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">tty_write</span>(<span class="cm-variable">tty</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//立即显示到屏幕上</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">PUTCH</span>(<span class="cm-variable">c</span>,<span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">secondary</span>);<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//完成copy_to_cooked</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">wake_up</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">secondary</span>.<span class="cm-variable">proc_list</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 431px;"></div><div class="CodeMirror-gutters" style="display: none; height: 431px;"></div></div></div></pre><p>&nbsp;</p><p><span>现在继续分析从设备出发的那条线,对于键盘,用户发起的文件操作是scanf，而 scanf调用的是sys_read(0,buf,count),其中 fd=0表示标准输入。找到设备文件的FCB 以后可以发现这个设备文件仍然是&quot;&quot;/dev/tty0&quot;,根据 printf 的文件视图路线不难类推,通过一系列分支后最后会执行tty.read (代码如下)。而 tty.read 的核心就是要和键盘中断处理程序中的 wake.up 接上,所以这里面有句非常重要的语句: sleep__if_empty(&amp;tty-&gt;secondary)。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//tty_read核心代码</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//一旦tty-&gt;secondary中有内容了，即键盘中断处理程序中将按键的ASCII码放进去以后,tty_read,实际上就是用户的scanf继续执行,会将tty-&gt;secondary中的字符逐个取出来(GETCH(tty-&gt;secondary,c)）复制到用户内存buf 中(put_fs_byte(c,b++))。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">tty_read</span>(<span class="cm-variable-3">unsigned</span> <span class="cm-variable">channel，char</span> <span class="cm-operator">*</span> <span class="cm-variable">buf</span>,<span class="cm-variable-3">int</span> <span class="cm-variable">nr</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">sleep_if_empty</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">secondary</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">do</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">GETCH</span>(<span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">secondary</span>,<span class="cm-variable">c</span>);<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//将tty-&gt;secondary中的字符逐个取出</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">secondary</span>.<span class="cm-variable">data</span><span class="cm-operator">--</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">put_fs_byte</span>(<span class="cm-variable">c</span>,<span class="cm-variable">b</span><span class="cm-operator">++</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//复制到用户内存buf中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  } <span class="cm-keyword">while</span> (<span class="cm-variable">nr</span><span class="cm-operator">&gt;</span><span class="cm-number">0</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">!</span><span class="cm-variable">EMPTY</span>(<span class="cm-variable">tty</span><span class="cm-operator">-&gt;</span><span class="cm-variable">secondary</span>)) ;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ......</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//到现在,按键对应的ASCII字符已经被逐个放到用户缓存区 buf中了,从设备开始的路线最后回到了文件操作scanf。</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 363px;"></div><div class="CodeMirror-gutters" style="display: none; height: 363px;"></div></div></div></pre><p><span>实际上这构成了从设备中断出发又回到文件视图的一个基本结构:</span></p><ul><li><span>进程通过文件读接口&quot;read”发起一个设备读动作,接下来该进程会在文件视图路线中阻塞,因为这个时候设备还没有将进程要读的东西准备好。</span></li><li><span>设备开始工作,工作完成以后会中断CPU,操作系统在设备中断处理时,会将设备上的内容放入到内存缓冲区中,并唤醒阻塞等待的进程,醒来的那个进程从缓冲区取出内容进行处理。</span></li><li><span>文件操作是由用户发起的,即用户启动了一个进程调用“read”来发起设备读操作;</span></li><li><span>设备中断是由设备动作发起的,由操作系统的中断处理函数负责处理,两条线之间通过上述同步机制连接在一起。</span></li></ul><p>&nbsp;</p><p><span>现在, keyboard_interrupt →inb 0x60, al → do_self → read_q →copy_to_cooked → secondary→wake_up → tty_read → rw_ttyx → rw_char → sys_read → read → scanf,这条从键盘中断到“inb $0x60,%al”,最后到scanf 的路线也完整了。</span></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='文件系统'><span>文件系统</span></h2><p><span>虽然是文件系统,但归根结底是对磁盘的驱动。具体来说,在磁盘驱动过程中发现直接使用磁盘很烦琐,因此引人了五层抽象机制:(1)从扇区到磁盘块的抽象,(2)从单个盘块请求到多个进程的磁盘请求队列,(3)从磁盘请求到高速缓存,(4)从盘块集合到文件的抽象,(5)从多个文件到构建文件系统。</span></p><h3 id='认识磁盘'><span>认识磁盘</span></h3><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220817164518583.png" alt="image-20220817164518583" style="zoom:50%;" /></p><p><span>磁盘读写的具体过程：</span></p><ul><li><span>寻道：磁头移动到指定磁道</span></li><li><span>旋转：旋转磁盘，把要读写的扇区移动到磁头下面。</span></li><li><span>数据传输：开始读写，内存读取，磁生电，把电信号传递给内存缓冲区；向磁盘写，电生磁，从内存缓冲区传递电信号，电生磁写到磁盘上。</span></li></ul><p>&nbsp;</p><h3 id='第一层抽象从扇区到磁盘块请求'><span>第一层抽象：从扇区到磁盘块请求</span></h3><p><span>操作系统在磁盘读写的过程中，最浪费时间的操作是寻道和旋转磁盘，因为是物理运动，时间慢。</span></p><p><span>因为数据传输时间和寻道/旋转时间相比要小得多,所以寻道、旋转一次读写k个扇区的策略比只读写1个扇区的策略,其磁盘读写速度的提高接近于k倍。所以抽象出磁盘块以后,磁盘读写速度会有非常显著的提高。当然,以磁盘块作为磁盘读写的基本单位也有缺点,那就是会造成磁盘空间的浪费。这是显然的,以1MB作为单位进行磁盘分配,一个文件平均会造成0.5 MB的空间浪费,即该文件的最后一个盘块即使没有用满也不能分配给其他的文件使用了。</span></p><p>&nbsp;</p><h3 id='第二层抽象多个进程产生的磁盘请求队列'><span>第二层抽象：多个进程产生的磁盘请求队列</span></h3><p><span>经过该层抽象以后,操作系统要处理磁盘读写完成如下工作:(1)从队列中选择一个磁盘请求;(2)取出请求读写的盘块号，(3)根据盘块号计算出C、H、S，(4)用out语句向磁盘控制器发出具体指令。在这些步骤中,第(2)～(4)步前面已经论述过,此处主要论述步骤(1),即如何从多个请求中选择出一个合适的请求来分配资源,这是典型的调度算法,所以第二层抽象的核心就是磁盘调度算法。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220817174014174.png" alt="image-20220817174014174" style="zoom:50%;" /></p><p><span>电梯调度算法：首先向某个方向（比如柱面号小的方向）进行扫描，处理经过的所有磁盘请求（不回弹），直到这个方向不再磁盘请求时磁头迅速复位到另一个方向的最大请求位置，然后再沿着同样方向（柱面号小的方向）进行扫描，处理经过的所有磁盘请求，如此反复。</span></p><p>&nbsp;</p><h3 id='第三层抽象从磁盘请求到高速缓存'><span>第三层抽象：从磁盘请求到高速缓存</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//磁盘读写时的数据要经过用户态内存、内核态内存以及磁盘扇区三个地方,很可能发生这样的情况:用户要从磁盘上读100 B的内容,由于磁盘的读写单位是磁盘块,所以虽然用户要读100 B,但真正读入的数据内容很可能要大于100 B。以前面给出的代码为例,一个磁盘块的大小是2个扇区,即 1024 B,所以每次读入的磁盘数据大小是1024 B。用户在处理完100B后,遵循程序的局部性,很可能会处理下100 B,这时就没必要再去读磁盘了,因为刚才读入的1024B仍然保留在如图9.10所示的内核态内存中。</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//这样的机制会大幅减少磁盘读写次数,从而大幅提高磁盘的使用效率。这个机制就是本节要论述的核心内容——磁盘高速缓存,现实中的绝大多数操作系统都支持磁盘高速缓存。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 181px;"></div><div class="CodeMirror-gutters" style="display: none; height: 181px;"></div></div></div></pre><p><span>磁盘高速缓存是磁盘管理的又一层抽象,即操作系统将磁盘数据“变成”一系列位于内核态内存中的缓存区内容。具体来说,从用户角度出发，磁盘读写变成了高速缓存读写，用户向高速缓存发出读写请求,如果用户请求的数据在高速缓存中,操作系统会直接将信息返回;如果不在,才发出磁盘请求去读写磁盘。当然操作系统的这些处理对用户而言是透明的,所以在用户的眼里,操作磁盘变成了操作高速缓存,这就是我们所说的第三层抽象。</span></p><p><span>设计磁盘高速缓存的核心就是要建立两个数据结构: 用一个散列表组织有内容的缓存块,再用一个空闲链接组织那些空闲的缓存块。散列表提供一种机制来快速查找一个磁盘块数据是否在高速缓存中。</span></p><p><span>如果发现高速缓存中没有用户请求的磁盘块,此时应该去读写物理磁盘,这就要求在高速缓存中取出一个空闲缓存块,用来缓存从磁盘块中读出的数据,而组织空闲缓存块通常使用的数据结构就是空闲链表。</span></p><p>&nbsp;</p><h3 id='第四层抽象引出文件'><span>第四层抽象：引出文件</span></h3><p><span>操作系统完成了从磁盘块到字符流的映射。</span></p><p><span>实现文件抽象的关键就在于能根据字符流的位置找到对应的盘块号，即建立字符流和盘块号之间的映射关系。这种映射关系就是字符流在磁盘上的存放位置，描述了一个文件全部字符流的存放位置就是这个映射表。</span></p><p>&nbsp;</p><h4 id='顺序存储结构'><span>顺序存储结构</span></h4><p><span>对于顺序存储结构,完成这个映射核心信息是文件名、起始块号、文件长度,这些信息可以用一个核心数据结构——文件控制块(FCB)来组织和保存。</span></p><p><span>顺序存储结构是一种字符流存储方案,这种方案有其优点:访问任何一个字符流位置都能根据上面给出的公式快速计算出对应的磁盘块号。但这种方案也有一个很大的缺点:如果要对文件进行改写,比如要在文件的某个中间位置添加一些字符。为保证添加以后的字符流在磁盘上仍连续存放,需要将这个中间位置以后的磁盘块内容全部往后挪动,即要逐个将这些后面的磁盘块读人并写出到下一个磁盘块上,这需要大量的磁盘读写操作,非常费时。</span></p><p>&nbsp;</p><h4 id='链式存储结构'><span>链式存储结构</span></h4><p><span>链式存储结构的实现方案也很简单:文件字符流存放的磁盘块不需要连续,只要每个磁盘块中存放下一个字符流片段所在的盘块号即可。</span></p><p><span>对于链式存储结构而言,操作系统在FCB中需要存放的主要映射信息仍然是第一个磁盘块的盘块号,利用这个信息可以找到文件的第一个磁盘块,再利用每个磁盘块中存放的下一个盘块号,可以找到第二个磁盘块,以此类推,可以计算出文件中任何字符流位置所对应的盘块号。</span></p><p><span>链式存储结构修改快，但是查找慢。</span></p><p>&nbsp;</p><h4 id='索引存储结构'><span>索引存储结构</span></h4><p><span>索引存储结构:索引节点(就是文件的FCB,因为是索引结构,所以通常被称作</span><strong><span>索引节点, index node,简称 inode</span></strong><span>)中存放了直接数据块号、索引块号以及间接索引块号三个部分。</span></p><p><span>索引存储结构下的文件映射方案也容易理解,文件字符流被分割成多个逻辑块,在物理磁盘上寻找一些空闲物理盘块(无须连续),将这些逻辑块的内容存放进去,再找一个磁盘块作为索引块,其中按序存放各个逻辑块对应的物理磁盘块号。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220817195740608.png" alt="image-20220817195740608" style="zoom:50%;" /></p><p><span>显然对于文件读操作的效率而言,索引存储结构是顺序存储结构和链式存储结构的折中。另外,索引存储结构下字符流不用在物理磁盘上连续存放,所以文件的动态修改也不困难,无须像顺序存储结构那样大量移动物理盘块。因此索引存储结构针对文件读操作和文件写操作都具有不错的性能。</span></p><p>&nbsp;</p><h4 id='多级索引'><span>多级索引</span></h4><p><img src="F:\Note\HouJie_C++\Markdown\OS_Node\image\L29_2.png" referrerpolicy="no-referrer" alt="image-20220817200139067"></p><p><span>(1)首先是索引存储结构,所以能较好地支持文件读操作和写操作。(2)如果文件比较小,比如小于6个盘块,可以利用inode(在读写文件时这个数据结构通常是已经读入到内存中)中存储的直接数据块信息找到逻辑盘块对应的物理盘块号,读写速度很快。(3)对于中等大小的文件,只要读入一阶索引块以后就能映射出物理盘块号,速度也不慢。(4)通过多阶间接索引,可以映射尺寸很大的文件。而且即使文件尺寸很大,索引的阶数也不会很大,这是因为文件尺寸和索引阶数是一个指数关系,所以对于很大尺寸的文件存取也不太慢。</span></p><p>&nbsp;</p><h3 id='第五层抽象将整个磁盘抽象成一个文件系统'><span>第五层抽象：将整个磁盘抽象成一个文件系统</span></h3><p><span>操作系统给上层用户展现出一棵目录树,一棵既可以静态读写又可以动态修改的目录树,通过操纵这棵目录树来让计算机为用户做各种各样的事情。</span></p><p><span>目录内容中存放文件的名字和FCB地址。</span></p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220817202112923.png" alt="image-20220817202112923" style="zoom:50%;" /></p><p>&nbsp;</p><h2 id='文件使用磁盘的实现'><span>文件使用磁盘的实现</span></h2><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220817203649236.png" alt="image-20220817203649236" style="zoom:50%;" /></p><p><span>打开文件是文件名到文件inode的映射</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//在fs/read_write.c中</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">sys_write</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">fd</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span> , <span class="cm-variable-3">int</span> <span class="cm-variable">count</span>)<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//fd:文件描述符;buf:内存缓冲区;count:读写字符的数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{ </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">struct</span> <span class="cm-def">file</span> <span class="cm-operator">*</span><span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-variable">current</span><span class="cm-operator">-&gt;</span><span class="cm-variable">filp</span>[<span class="cm-variable">fd</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">struct</span> <span class="cm-def">m_inode</span> <span class="cm-operator">*</span><span class="cm-variable">inode</span> <span class="cm-operator">=</span> <span class="cm-variable">file</span><span class="cm-operator">-&gt;</span><span class="cm-variable">inode</span>;<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//读取FCB中的inode,inode是映射表</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">s_ISREG</span>(<span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_mode</span>) )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">file_write</span>(<span class="cm-variable">inode</span>, <span class="cm-variable">file</span>, <span class="cm-variable">buf</span>, <span class="cm-variable">count</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 227px;"></div><div class="CodeMirror-gutters" style="display: none; height: 227px;"></div></div></div></pre><p>&nbsp;</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220817203815925.png" alt="image-20220817203815925" style="zoom:50%;" /></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">file_write</span> (<span class="cm-keyword">struct</span> <span class="cm-def">m_inode</span> <span class="cm-operator">*</span><span class="cm-variable">inode</span>, <span class="cm-keyword">struct</span> <span class="cm-def">file</span> <span class="cm-operator">*</span><span class="cm-variable">filp</span>, <span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">buf</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">count</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">off_t</span> <span class="cm-variable">pos</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">filp</span><span class="cm-operator">-&gt;</span><span class="cm-variable">f_flags</span><span class="cm-operator">&amp;</span><span class="cm-variable">o_APPEND</span>)<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//如果是追加</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">pos</span><span class="cm-operator">=</span><span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_size</span>; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//pos是字符流的读写位置。指针放在文件末尾</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">pos</span><span class="cm-operator">=</span><span class="cm-variable">filp</span><span class="cm-operator">-&gt;</span><span class="cm-variable">f_pos</span> ;<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//f_pos是file里面的文件读写指针</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//用file知道文件流读写的字符区间，从哪到哪</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">while</span> (<span class="cm-variable">i</span><span class="cm-operator">&lt;</span><span class="cm-variable">count</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">block</span><span class="cm-operator">=</span><span class="cm-variable">create_block</span> (<span class="cm-variable">inode</span>, <span class="cm-variable">pos</span><span class="cm-operator">/</span><span class="cm-variable">BLOCK_SIZE</span>);<span class="cm-comment">//算出对应的块!</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">bh</span><span class="cm-operator">=</span><span class="cm-variable">bread</span> (<span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_dev</span>, <span class="cm-variable">block</span>);<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//放入“电梯”队列!</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">c</span><span class="cm-operator">=</span><span class="cm-variable">pos</span><span class="cm-operator">%</span><span class="cm-variable">BLOCK_SIZE</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">p</span><span class="cm-operator">=</span><span class="cm-variable">c</span><span class="cm-operator">+</span><span class="cm-variable">bh</span><span class="cm-operator">-&gt;</span><span class="cm-variable">b_data</span> ;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">bh</span><span class="cm-operator">-&gt;</span><span class="cm-variable">b_dirt</span><span class="cm-operator">=</span><span class="cm-number">1</span> ; <span class="cm-variable">c</span><span class="cm-operator">=</span><span class="cm-variable">BLOCK_SIZE</span><span class="cm-operator">-</span><span class="cm-variable">C</span>; <span class="cm-variable">pos</span><span class="cm-operator">+=</span><span class="cm-variable">C</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ... <span class="cm-keyword">while</span>(<span class="cm-variable">c</span><span class="cm-operator">--&gt;</span><span class="cm-number">0</span>) <span class="cm-operator">*</span>(<span class="cm-variable">p</span><span class="cm-operator">++</span>)<span class="cm-operator">=</span><span class="cm-variable">get</span> <span class="cm-variable">fs</span> <span class="cm-variable">byte</span> (<span class="cm-variable">buf</span><span class="cm-operator">++</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">brelse</span> (<span class="cm-variable">bh</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }<span class="cm-comment">//一块一块拷贝用户字符，并且释放写出!</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">filp</span><span class="cm-operator">-&gt;</span><span class="cm-variable">f</span> <span class="cm-variable">pos</span><span class="cm-operator">=</span><span class="cm-variable">pos</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-comment">//修改pos,使之总是对!</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 453px;"></div><div class="CodeMirror-gutters" style="display: none; height: 453px;"></div></div></div></pre><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">struct d_inode{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>unsigned short i_mode;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>.....</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>unsigned short i_zone[9];<span class="cm-tab" role="presentation" cm-text="	">   </span>//表示的是在FCB中的索引项</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 113px;"></div><div class="CodeMirror-gutters" style="display: none; height: 113px;"></div></div></div></pre><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//creat_block算盘块，文件抽象的核心</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span>(<span class="cm-variable">i</span><span class="cm-operator">&lt;</span><span class="cm-variable">count</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">block</span> <span class="cm-operator">=</span> <span class="cm-variable">creat_block</span>(<span class="cm-variable">inode</span>,<span class="cm-variable">pos</span><span class="cm-operator">/</span><span class="cm-variable">BLOCK_SIZE</span>);<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//create=1的_bmap,没有映射时创建映射</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">bh</span> <span class="cm-operator">=</span> <span class="cm-variable">bread</span>(<span class="cm-variable">inode</span> <span class="cm-operator">-&gt;</span> <span class="cm-variable">i_dev</span>,<span class="cm-variable">block</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">_bmap</span>(<span class="cm-variable">m_inode</span> <span class="cm-operator">*</span><span class="cm-variable">inode</span>,<span class="cm-variable-3">int</span> <span class="cm-variable">block</span>,<span class="cm-variable-3">int</span> <span class="cm-variable">create</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">block</span><span class="cm-operator">&lt;</span><span class="cm-number">7</span>){<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//(0-6):直接数据块，直接索引</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">create</span><span class="cm-operator">&amp;&amp;!</span><span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_zone</span>[<span class="cm-variable">block</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_zone</span>[<span class="cm-variable">block</span>]<span class="cm-operator">=</span><span class="cm-variable">new_block</span>(<span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_dev</span>);<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-comment">//直接读取索引块</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_ctime</span><span class="cm-operator">=</span><span class="cm-variable">CURRENT_TIME</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_dirt</span><span class="cm-operator">=</span><span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_zone</span>[<span class="cm-variable">block</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">block</span><span class="cm-operator">-=</span><span class="cm-number">7</span>;<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//多级索引，第7块存储在一重间接的指向的第0块，以此类推</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">block</span><span class="cm-operator">&lt;</span><span class="cm-number">512</span>)<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-comment">//一个索引块也需要用盘快存储，一个盘块1024个字节，一个索引项2个字节，一个索引块能存储512个索引项。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">bh</span><span class="cm-operator">=</span><span class="cm-variable">bread</span>(<span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_dev</span>,<span class="cm-variable">inode</span><span class="cm-operator">-&gt;</span><span class="cm-variable">i_zone</span>[<span class="cm-number">7</span>]);<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//先把索引块读进来再找</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> (<span class="cm-variable">bh</span><span class="cm-operator">-&gt;</span><span class="cm-variable">b_data</span>)[<span class="cm-variable">block</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>....</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 589px;"></div><div class="CodeMirror-gutters" style="display: none; height: 589px;"></div></div></div></pre><p>&nbsp;</p></div></div>
</body>
</html>